<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="天行健、君子以自强不息；地势坤，君子以厚德载物。">
    <meta name="keyword"  content="兰草">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
        hive企业综合案例实战 - kfly的博客 | kfly&#39;s Blog
        
    </title>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/aircloud.css">
    <link rel="stylesheet" href="/css/gitment.css">
    <link rel="stylesheet" href="//at.alicdn.com/t/font_1598291_q3el2wqimj.css" type="text/css">
    <link href="//at.alicdn.com/t/font_620856_pl6z7sid89qkt9.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
</head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i> 君子谦谦，温和有礼，有才而不骄，得志而不傲，居于谷而不卑。 </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar ">
            <img src="/img/avatar.jpg" />
        </div>
        <div class="name">
            <i>kfly</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li >
                <a href="/">
                    <i class="iconfont iconhome"></i>
                    <span>主页</span>
                </a>
            </li>
 	   <li >
                <a href="/spec/">
                    <i class="iconfont iconzhuanti"></i>
                    <span>专题</span>
                </a>
            </li>
            <li >
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>标签</span>
                </a>
            </li>
            <li >
                <a href="/archive">
                    <i class="iconfont icon-guidang2"></i>
                    <span>存档</span>
                </a>
            </li>
            <li >
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>简历</span>
                </a>
            </li>
            
            <li>
                <a id="search">
                    <i class="iconfont icon-sousuo1"></i>
                    <span>搜索</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#hive的综合案例实战"><span class="toc-text">hive的综合案例实战</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1、需求描述"><span class="toc-text">1、需求描述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2、项目表字段"><span class="toc-text">2、项目表字段</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1、数据结构"><span class="toc-text">1、数据结构</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3、ETL原始数据清洗"><span class="toc-text">3、ETL原始数据清洗</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4、项目建表并加载数据"><span class="toc-text">4、项目建表并加载数据</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1、创建表"><span class="toc-text">1、创建表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2、导入ETL之后的数据"><span class="toc-text">2、导入ETL之后的数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3、向ORC表插入数据"><span class="toc-text">3、向ORC表插入数据</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5、业务分析"><span class="toc-text">5、业务分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1、统计视频观看数Top10"><span class="toc-text">1、统计视频观看数Top10</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2、统计视频类别热度Top10"><span class="toc-text">2、统计视频类别热度Top10</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3、统计出视频观看数最高的20个视频的所属类别以及类别包含Top20视频的个数"><span class="toc-text">3、统计出视频观看数最高的20个视频的所属类别以及类别包含Top20视频的个数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4、-统计视频观看数Top50所关联视频的所属类别Rank"><span class="toc-text">4、 统计视频观看数Top50所关联视频的所属类别Rank</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5、统计每个类别中的视频热度Top10，以Music为例"><span class="toc-text">5、统计每个类别中的视频热度Top10，以Music为例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6、-统计每个类别中视频流量Top10，以Music为例"><span class="toc-text">6、 统计每个类别中视频流量Top10，以Music为例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7、-统计上传视频最多的用户Top10以及他们上传的观看次数在前20的视频"><span class="toc-text">7、 统计上传视频最多的用户Top10以及他们上传的观看次数在前20的视频</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8、统计每个类别视频观看数Top10"><span class="toc-text">8、统计每个类别视频观看数Top10</span></a></li></ol></li></ol></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input"/>
            <span id="begin-search">搜索</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>

        <div class="index-about-mobile">
            <i> 君子谦谦，温和有礼，有才而不骄，得志而不傲，居于谷而不卑。 </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        hive企业综合案例实战
    </div>

    <div class="post-meta">
        <span class="attr">发布于：<span>2010-02-10 16:01:32</span></span>
        
        <span class="attr">标签：/
        
        <a class="tag" href="/tags/#项目练习" title="项目练习">项目练习</a>
        <span>/</span>
        
        <a class="tag" href="/tags/#hadoop" title="hadoop">hadoop</a>
        <span>/</span>
        
        <a class="tag" href="/tags/#hive" title="hive">hive</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">访问：<span id="busuanzi_value_page_pv"></span>
</span>
</span>
    </div>
    <div class="post-content ">
        <h1 id="hive的综合案例实战"><a href="#hive的综合案例实战" class="headerlink" title="hive的综合案例实战"></a>hive的综合案例实战</h1><h2 id="1、需求描述"><a href="#1、需求描述" class="headerlink" title="1、需求描述"></a>1、需求描述</h2><p>统计youtube影音视频网站的常规指标，各种TopN指标：</p>
<p>–统计视频观看数Top10</p>
<p>–统计视频类别热度Top10</p>
<p>–统计视频观看数Top20所属类别</p>
<p>–统计视频观看数Top50所关联视频的所属类别Rank</p>
<p>–统计每个类别中的视频热度Top10</p>
<p>–统计每个类别中视频流量Top10</p>
<p>–统计上传视频最多的用户Top10以及他们上传的视频</p>
<p>–统计每个类别视频观看数Top10</p>
<h2 id="2、项目表字段"><a href="#2、项目表字段" class="headerlink" title="2、项目表字段"></a>2、项目表字段</h2><h3 id="1、数据结构"><a href="#1、数据结构" class="headerlink" title="1、数据结构"></a>1、数据结构</h3><p>1．视频表</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>备注</th>
<th>详细描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>video id</td>
<td>视频唯一id</td>
<td>11位字符串</td>
</tr>
<tr>
<td>uploader</td>
<td>视频上传者</td>
<td>上传视频的用户名String</td>
</tr>
<tr>
<td>age</td>
<td>视频年龄</td>
<td>视频在平台上的整数天</td>
</tr>
<tr>
<td>category</td>
<td>视频类别</td>
<td>上传视频指定的视频分类</td>
</tr>
<tr>
<td>length</td>
<td>视频长度</td>
<td>整形数字标识的视频长度</td>
</tr>
<tr>
<td>views</td>
<td>观看次数</td>
<td>视频被浏览的次数</td>
</tr>
<tr>
<td>rate</td>
<td>视频评分</td>
<td>满分5分</td>
</tr>
<tr>
<td>ratings</td>
<td>流量</td>
<td>视频的流量，整型数字</td>
</tr>
<tr>
<td>conments</td>
<td>评论数</td>
<td>一个视频的整数评论数</td>
</tr>
<tr>
<td>related   ids</td>
<td>相关视频id</td>
<td>相关视频的id，最多20个</td>
</tr>
</tbody>
</table>
<p>2．用户表</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>备注</th>
<th>字段类型</th>
</tr>
</thead>
<tbody>
<tr>
<td>uploader</td>
<td>上传者用户名</td>
<td>string</td>
</tr>
<tr>
<td>videos</td>
<td>上传视频数</td>
<td>int</td>
</tr>
<tr>
<td>friends</td>
<td>朋友数量</td>
<td>int</td>
</tr>
</tbody>
</table>
<h2 id="3、ETL原始数据清洗"><a href="#3、ETL原始数据清洗" class="headerlink" title="3、ETL原始数据清洗"></a>3、ETL原始数据清洗</h2><p>通过观察原始数据形式，可以发现，视频可以有多个所属分类，每个所属分类用&amp;符号分割，且分割的两边有空格字符，同时相关视频也是可以有多个元素，多个相关视频又用“\t”进行分割。为了分析数据时方便对存在多个子元素的数据进行操作，我们首先进行数据重组清洗操作。即：将所有的类别用“&amp;”分割，同时去掉两边空格，多个相关视频id也使用“&amp;”进行分割。</p>
<p>三件事情</p>
<ol>
<li><p>长度不够9的删掉</p>
</li>
<li><p>视频类别删掉空格</p>
</li>
<li><p>该相关视频的分割符</p>
</li>
</ol>
<p>创建maven工程，并导入jar包</p>
<p>1、代码开发：ETLUtil</p>
<pre><code>public class VideoUtil {
    /**
     * 对我们的数据进行清洗的工作，
     * 数据切割，如果长度小于9 直接丢掉
     * 视频类别中间空格 去掉
     * 关联视频，使用 &amp;  进行分割
     * @param line
     * @return
     * FM1KUDE3C3k  renetto    736    News &amp; Politics    1063    9062    4.57    525    488    LnMvSxl0o0A&amp;IKMtzNuKQso&amp;Bq8ubu7WHkY&amp;Su0VTfwia1w&amp;0SNRfquDfZs&amp;C72NVoPsRGw
     */
    public  static String washDatas(String line){
        if(null == line || &quot;&quot;.equals(line)) {
            return null;
        }
        //判断数据的长度，如果小于9，直接丢掉
        String[] split = line.split(&quot;\t&quot;);
        if(split.length &lt;9){
            return null;
        }
        //将视频类别空格进行去掉
        split[3] =  split[3].replace(&quot; &quot;,&quot;&quot;);
        StringBuilder builder = new StringBuilder();
        for(int i =0;i&lt;split.length;i++){
            if(i &lt;9){
                //这里面是前面八个字段
                builder.append(split[i]).append(&quot;\t&quot;);
            }else if(i &gt;=9  &amp;&amp; i &lt; split.length -1){
                builder.append(split[i]).append(&quot;&amp;&quot;);
            }else if( i == split.length -1){
                builder.append(split[i]);
            }
        }
        return  builder.toString();
    }
}
</code></pre><p>2、代码开发：ETLMapper</p>
<pre><code class="java">import org.apache.hadoop.io.LongWritable;
import org.apache.hadoop.io.NullWritable;
import org.apache.hadoop.io.Text;
import org.apache.hadoop.mapreduce.Mapper;
import java.io.IOException;

public class VideoMapper extends Mapper&lt;LongWritable,Text,Text,NullWritable&gt; {
    private Text  key2 ;
    @Override
    protected void setup(Context context) throws IOException, InterruptedException {
        key2 = new Text();
    }
    @Override
    protected void map(LongWritable key, Text value, Context context) throws IOException, InterruptedException {
        String s = VideoUtils.washDatas(value.toString());
        if(null != s ){
            key2.set(s);
            context.write(key2,NullWritable.get());
        }
    }
}
</code></pre>
<p>3、代码开发：ETLRunner</p>
<pre><code>import org.apache.hadoop.conf.Configuration;
import org.apache.hadoop.conf.Configured;
import org.apache.hadoop.fs.Path;
import org.apache.hadoop.io.NullWritable;
import org.apache.hadoop.io.Text;
import org.apache.hadoop.mapreduce.Job;
import org.apache.hadoop.mapreduce.lib.input.TextInputFormat;
import org.apache.hadoop.mapreduce.lib.output.TextOutputFormat;
import org.apache.hadoop.util.Tool;
import org.apache.hadoop.util.ToolRunner;

public class VideoMain extends Configured implements Tool {
    @Override
    public int run(String[] args) throws Exception {
        Job job = Job.getInstance(super.getConf(), &quot;washDatas&quot;);
        job.setJarByClass(VideoMain.class);
        job.setInputFormatClass(TextInputFormat.class);
        TextInputFormat.addInputPath(job,new Path(args[0]));

        job.setMapperClass(VideoMapper.class);
        job.setMapOutputKeyClass(Text.class);
        job.setMapOutputValueClass(NullWritable.class);
        job.setOutputFormatClass(TextOutputFormat.class);
        TextOutputFormat.setOutputPath(job,new Path(args[1]));
        //注意，我们这里没有自定义reducer，会使用默认的一个reducer类
        job.setNumReduceTasks(7);
        boolean b = job.waitForCompletion(true);
        return b?0:1;
    }
    public static void main(String[] args) throws Exception {
        int run = ToolRunner.run(new Configuration(), new VideoMain(), args);
        System.exit(run);
    }
}
</code></pre><h2 id="4、项目建表并加载数据"><a href="#4、项目建表并加载数据" class="headerlink" title="4、项目建表并加载数据"></a>4、项目建表并加载数据</h2><h3 id="1、创建表"><a href="#1、创建表" class="headerlink" title="1、创建表"></a>1、创建表</h3><p>创建表：youtubevideo_ori，youtubevideo_user_ori，</p>
<p>创建表：youtubevideo_orc，youtubevideo_user_orc</p>
<p>youtubevideo_ori：</p>
<p>开启分桶表功能</p>
<pre><code>set hive.enforce.bucketing=true;
set mapreduce.job.reduces=-1;

create database youtube;
use youtube;
create table youtubevideo_ori(
    videoId string, 
    uploader string, 
    age int, 
    category array&lt;string&gt;, 
    length int, 
    views int, 
    rate float, 
    ratings int, 
    comments int,
    relatedId array&lt;string&gt;)
row format delimited 
fields terminated by &quot;\t&quot;
collection items terminated by &quot;&amp;&quot;
stored as textfile;
</code></pre><p>youtubevideo_user_ori：</p>
<pre><code>create table youtubevideo_user_ori(
    uploader string,
    videos int,
    friends int)
clustered by (uploader) into 24 buckets
row format delimited 
fields terminated by &quot;\t&quot; 
stored as textfile;

</code></pre><p>然后把原始数据插入到orc表中</p>
<p>youtubevideo_orc：</p>
<pre><code>create table youtubevideo_orc(
    videoId string, 
    uploader string, 
    age int, 
    category array&lt;string&gt;, 
    length int, 
    views int, 
    rate float, 
    ratings int, 
    comments int,
    relatedId array&lt;string&gt;)
clustered by (uploader) into 8 buckets 
row format delimited fields terminated by &quot;\t&quot; 
collection items terminated by &quot;&amp;&quot; 
stored as orc;
</code></pre><p>youtubevideo_user_orc：</p>
<pre><code>create table youtubevideo_user_orc(
    uploader string,
    videos int,
    friends int)
clustered by (uploader) into 24 buckets 
row format delimited 
fields terminated by &quot;\t&quot; 
stored as orc;

</code></pre><h3 id="2、导入ETL之后的数据"><a href="#2、导入ETL之后的数据" class="headerlink" title="2、导入ETL之后的数据"></a>2、导入ETL之后的数据</h3><p>youtubevideo_ori：</p>
<pre><code>load data inpath &quot;/youtubevideo/output/video/2008/0222&quot; into table youtubevideo_ori;
</code></pre><p>youtubevideo_user_ori：</p>
<pre><code>load data inpath &quot;/youtubevideo/user/2008/0903&quot; into table youtubevideo_user_ori;
</code></pre><h3 id="3、向ORC表插入数据"><a href="#3、向ORC表插入数据" class="headerlink" title="3、向ORC表插入数据"></a>3、向ORC表插入数据</h3><p>youtubevideo_orc：</p>
<pre><code>insert overwrite table youtubevideo_orc select * from youtubevideo_ori;
</code></pre><p>youtubevideo_user_orc：</p>
<pre><code>insert into table youtubevideo_user_orc select * from youtubevideo_user_ori;
</code></pre><h2 id="5、业务分析"><a href="#5、业务分析" class="headerlink" title="5、业务分析"></a>5、业务分析</h2><h3 id="1、统计视频观看数Top10"><a href="#1、统计视频观看数Top10" class="headerlink" title="1、统计视频观看数Top10"></a>1、统计视频观看数Top10</h3><p>思路：使用order by按照views字段做一个全局排序即可，同时我们设置只显示前10条。</p>
<p>最终代码：</p>
<pre><code class="sql">select 
    videoId, 
    uploader, 
    age, 
    category, 
    length, 
    views, 
    rate, 
    ratings, 
    comments 
from 
    youtubevideo_orc 
order by 
    views 
desc limit 
    10;

</code></pre>
<h3 id="2、统计视频类别热度Top10"><a href="#2、统计视频类别热度Top10" class="headerlink" title="2、统计视频类别热度Top10"></a>2、统计视频类别热度Top10</h3><p>思路：</p>
<p>1) 即统计每个类别有多少个视频，显示出包含视频最多的前10个类别。</p>
<p>2) 我们需要按照类别group by聚合，然后count组内的videoId个数即可。</p>
<p>3) 因为当前表结构为：一个视频对应一个或多个类别。所以如果要group by类别，需要先将类别进行列转行(展开)，然后再进行count即可。</p>
<p>4) 最后按照热度排序，显示前10条。</p>
<p>最终代码：</p>
<pre><code class="sql">select 
    category_name as category, 
    count(t1.videoId) as hot 
from (
    select 
        videoId,
        category_name 
    from 
        youtubevideo_orc lateral view explode(category) t_catetory as category_name) t1 
group by 
    t1.category_name 
order by 
    hot 
desc limit 
    10;

</code></pre>
<h3 id="3、统计出视频观看数最高的20个视频的所属类别以及类别包含Top20视频的个数"><a href="#3、统计出视频观看数最高的20个视频的所属类别以及类别包含Top20视频的个数" class="headerlink" title="3、统计出视频观看数最高的20个视频的所属类别以及类别包含Top20视频的个数"></a>3、统计出视频观看数最高的20个视频的所属类别以及类别包含Top20视频的个数</h3><p>思路：</p>
<p>1) 先找到观看数最高的20个视频所属条目的所有信息，降序排列</p>
<p>2) 把这20条信息中的category分裂出来(列转行)</p>
<p>3) 最后查询视频分类名称和该分类下有多少个Top20的视频</p>
<p>最终代码：</p>
<pre><code class="sql">select 
    category_name as category, 
    count(t2.videoId) as hot_with_views 
from (
    select 
        videoId, 
        category_name 
    from (
        select 
            * 
        from 
            youtubevideo_orc 
        order by 
            views 
        desc limit 
            20) t1 lateral view explode(category) t_catetory as category_name) t2 
group by 
    category_name 
order by 
    hot_with_views 
desc;
</code></pre>
<h3 id="4、-统计视频观看数Top50所关联视频的所属类别Rank"><a href="#4、-统计视频观看数Top50所关联视频的所属类别Rank" class="headerlink" title="4、 统计视频观看数Top50所关联视频的所属类别Rank"></a>4、 统计视频观看数Top50所关联视频的所属类别Rank</h3><p>思路：</p>
<p>1)       查询出观看数最多的前50个视频的所有信息(当然包含了每个视频对应的关联视频)，记为临时表t1</p>
<p>t1：观看数前50的视频</p>
<pre><code class="sql">select 
    * 
from 
    youtubevideo_orc 
order by 
    views 
desc limit 
    50;
</code></pre>
<p>2)       将找到的50条视频信息的相关视频relatedId列转行，记为临时表t2</p>
<p>t2：将相关视频的id进行列转行操作</p>
<pre><code>select 
    explode(relatedId) as videoId 
from 
    t1;


</code></pre><p>3)       将相关视频的id和youtubevideo_orc表进行inner join操作</p>
<p>t5：得到两列数据，一列是category，一列是之前查询出来的相关视频id</p>
<pre><code>(select 
    distinct(t2.videoId), 
    t3.category 
from 
    t2
inner join 
    youtubevideo_orc t3 on t2.videoId = t3.videoId) t4 lateral view explode(category) t_catetory as category_name;


</code></pre><p>4) 按照视频类别进行分组，统计每组视频个数，然后排行</p>
<p>最终代码：</p>
<pre><code>select 
    category_name as category, 
    count(t5.videoId) as hot 
from (
    select 
        videoId, 
        category_name 
    from (
        select 
            distinct(t2.videoId), 
            t3.category 
        from (
            select 
                explode(relatedId) as videoId 
            from (
                select 
                    * 
                from 
                    youtubevideo_orc 
                order by 
                    views 
                desc limit 
                    50) t1) t2 
        inner join 
            youtubevideo_orc t3 on t2.videoId = t3.videoId) t4 lateral view explode(category) t_catetory as category_name) t5
group by 
    category_name 
order by 
    hot 
desc;


</code></pre><h3 id="5、统计每个类别中的视频热度Top10，以Music为例"><a href="#5、统计每个类别中的视频热度Top10，以Music为例" class="headerlink" title="5、统计每个类别中的视频热度Top10，以Music为例"></a>5、统计每个类别中的视频热度Top10，以Music为例</h3><p>思路：</p>
<p>1) 要想统计Music类别中的视频热度Top10，需要先找到Music类别，那么就需要将category展开，所以可以创建一张表用于存放categoryId展开的数据。</p>
<p>2) 向category展开的表中插入数据。</p>
<p>3) 统计对应类别（Music）中的视频热度。</p>
<p>最终代码：</p>
<p>创建表类别表：</p>
<pre><code>create table youtubevideo_category(
    videoId string, 
    uploader string, 
    age int, 
    categoryId string, 
    length int, 
    views int, 
    rate float, 
    ratings int, 
    comments int, 
    relatedId array&lt;string&gt;)
row format delimited 
fields terminated by &quot;\t&quot; 
collection items terminated by &quot;&amp;&quot; 
stored as orc;


</code></pre><p>向类别表中插入数据：</p>
<pre><code>insert into table youtubevideo_category  
    select 
        videoId,
        uploader,
        age,
        categoryId,
        length,
        views,
        rate,
        ratings,
        comments,
        relatedId 
    from 
        youtubevideo_orc lateral view explode(category) catetory as categoryId;

</code></pre><p>统计Music类别的Top10（也可以统计其他）</p>
<pre><code>select 
    videoId, 
    views
from 
    youtubevideo_category 
where 
    categoryId = &quot;Music&quot; 
order by 
    views 
desc limit
    10;

</code></pre><h3 id="6、-统计每个类别中视频流量Top10，以Music为例"><a href="#6、-统计每个类别中视频流量Top10，以Music为例" class="headerlink" title="6、 统计每个类别中视频流量Top10，以Music为例"></a>6、 统计每个类别中视频流量Top10，以Music为例</h3><p>思路：</p>
<p>1) 创建视频类别展开表（categoryId列转行后的表）</p>
<p>2) 按照ratings排序即可</p>
<p>最终代码：</p>
<pre><code>select videoid,views,ratings 
from youtubevideo_category 
where categoryid = &quot;Music&quot; order by ratings desc limit 10;

</code></pre><h3 id="7、-统计上传视频最多的用户Top10以及他们上传的观看次数在前20的视频"><a href="#7、-统计上传视频最多的用户Top10以及他们上传的观看次数在前20的视频" class="headerlink" title="7、 统计上传视频最多的用户Top10以及他们上传的观看次数在前20的视频"></a>7、 统计上传视频最多的用户Top10以及他们上传的观看次数在前20的视频</h3><p>思路：</p>
<p>1) 先找到上传视频最多的10个用户的用户信息</p>
<pre><code class="sql">select 
    * 
from 
    youtubevideo_user_orc 
order by 
    videos 
desc limit 
    10;
</code></pre>
<p>2) 通过uploader字段与youtubevideo_orc表进行join，得到的信息按照views观看次数进行排序即可。</p>
<p>最终代码：</p>
<pre><code>select 
    t2.videoId, 
    t2.views,
    t2.ratings,
    t1.videos,
    t1.friends 
from (
    select 
        * 
    from 
        youtubevideo_user_orc 
    order by 
        videos desc 
    limit 
        10) t1 
join 
    youtubevideo_orc t2
on 
    t1.uploader = t2.uploader 
order by 
    views desc 
limit 
    20;
</code></pre><h3 id="8、统计每个类别视频观看数Top10"><a href="#8、统计每个类别视频观看数Top10" class="headerlink" title="8、统计每个类别视频观看数Top10"></a>8、统计每个类别视频观看数Top10</h3><p>思路：</p>
<p>1) 先得到categoryId展开的表数据</p>
<p>2) 子查询按照categoryId进行分区，然后分区内排序，并生成递增数字，该递增数字这一列起名为rank列</p>
<p>3) 通过子查询产生的临时表，查询rank值小于等于10的数据行即可。</p>
<p>最终代码：</p>
<pre><code>select 
    t1.* 
from (
    select 
        videoId,
        categoryId,
        views,
        row_number() over(partition by categoryId order by views desc) rank from youtubevideo_category) t1 
where 
    rank &lt;= 10;

</code></pre>
        
        <br />
        <div id="comment-container">
        </div>
        <div id="disqus_thread"></div>

        <div id="lv-container">
        </div>

    </div>
</div>

    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        

        

    </ul>
    
    <p>
        <span>/</span>
        
        <span><a href="https://blog.sev7e0.site/">大数据施工现场</a></span>
        <span>/</span>
        
        <span><a href="https://wangchujiang.com/linux-command/">linux命令</a></span>
        <span>/</span>
        
        <span><a href="http://redisdoc.com/">Redis命令</a></span>
        <span>/</span>
        
        <span><a href="https://github.com/orchid-ding">github</a></span>
        <span>/</span>
        
    </p>
    
    <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>
        Created By <a href="https://hexo.io/">Hexo</a>  Theme <a href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a></p>
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "search.json"
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="/js/index.js"></script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<script src="/js/gitment.js"></script>
<script>
    var gitment = new Gitment({
        id: 'hive企业综合案例实战',
        owner: 'orchid-ding',
        repo: 'kfly-blog-comment',
        oauth: {
            client_id: '0770cdab79393197b6f5',
            client_secret: '376fb6c7bcd5047718b356712f596b89e490360c',
        },
    })
    gitment.render('comment-container')
</script>




</html>
