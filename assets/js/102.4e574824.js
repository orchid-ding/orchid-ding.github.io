(window.webpackJsonp=window.webpackJsonp||[]).push([[102],{586:function(a,s,n){"use strict";n.r(s);var t=n(19),e=Object(t.a)({},(function(){var a=this,s=a.$createElement,n=a._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[n("h1",{attrs:{id:"案例分析"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#案例分析"}},[a._v("#")]),a._v(" 案例分析")]),a._v(" "),n("ul",[n("li",[a._v("实际开发中维表服务是经常遇到的。例如：\n"),n("ul",[n("li",[a._v("在水务项目中，来自水源地的不同监测点（压力、温度、氯气浓度）等监测点数据的报警规则改变。")]),a._v(" "),n("li",[a._v("用户行为数据中需要进行大区的转码")]),a._v(" "),n("li",[a._v("商品信息中心只包含了商品Id等")])])])]),a._v(" "),n("p",[a._v("上述案例中都可以使用维表服务解决。")]),a._v(" "),n("h2",{attrs:{id:"维表方案"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#维表方案"}},[a._v("#")]),a._v(" 维表方案")]),a._v(" "),n("h3",{attrs:{id:"预加载"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#预加载"}},[a._v("#")]),a._v(" 预加载")]),a._v(" "),n("ul",[n("li",[a._v("在flink中，凡是继承了RichFunction的算子，都含有open方法。 可以再此方法里面实现对数据的预加载。")])]),a._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[a._v(" RichMapFunction richMapFunction = new RichMapFunction<String>() {\n    \t\t\t\t@Override\n            public void open(Configuration parameters) throws Exception {\n                super.open(parameters);\n            }        \n   \t\t\t\t\t@Override\n            public Object map(String value) throws Exception {\n                return null;\n            }\n\t }\n// 如果数据变更频次较低的，可以追加每分钟频次的时间调度器。\n")])]),a._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[a._v("1")]),n("br"),n("span",{staticClass:"line-number"},[a._v("2")]),n("br"),n("span",{staticClass:"line-number"},[a._v("3")]),n("br"),n("span",{staticClass:"line-number"},[a._v("4")]),n("br"),n("span",{staticClass:"line-number"},[a._v("5")]),n("br"),n("span",{staticClass:"line-number"},[a._v("6")]),n("br"),n("span",{staticClass:"line-number"},[a._v("7")]),n("br"),n("span",{staticClass:"line-number"},[a._v("8")]),n("br"),n("span",{staticClass:"line-number"},[a._v("9")]),n("br"),n("span",{staticClass:"line-number"},[a._v("10")]),n("br"),n("span",{staticClass:"line-number"},[a._v("11")]),n("br")])]),n("ul",[n("li",[a._v("缺点\n"),n("ul",[n("li",[a._v("维度更新延迟")]),a._v(" "),n("li",[a._v("加载到内存中，不适合数据量较大的场景")])])])]),a._v(" "),n("h3",{attrs:{id:"热存储关联"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#热存储关联"}},[a._v("#")]),a._v(" 热存储关联")]),a._v(" "),n("ul",[n("li",[a._v("IO变为异步IO，可使用cache缓存热数据(以guava为例)")])]),a._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[a._v("Cache<String, String> cache = CacheBuilder\n                .newBuilder()\n                .expireAfterAccess(300,TimeUnit.MILLISECONDS) // 按照时间访问过期\n                .expireAfterWrite(300,TimeUnit.MICROSECONDS) // 写入时间过期\n                .build();\n// 维度数据加载延迟\n")])]),a._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[a._v("1")]),n("br"),n("span",{staticClass:"line-number"},[a._v("2")]),n("br"),n("span",{staticClass:"line-number"},[a._v("3")]),n("br"),n("span",{staticClass:"line-number"},[a._v("4")]),n("br"),n("span",{staticClass:"line-number"},[a._v("5")]),n("br"),n("span",{staticClass:"line-number"},[a._v("6")]),n("br")])]),n("h3",{attrs:{id:"广播维表"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#广播维表"}},[a._v("#")]),a._v(" 广播维表")]),a._v(" "),n("h4",{attrs:{id:"spark"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#spark"}},[a._v("#")]),a._v(" spark")]),a._v(" "),n("ul",[n("li",[a._v("spark的broacast变量定义为只读，所以只能手动更新")])]),a._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[a._v('// 监测点上报数据格式: P001,10(pointKey,value)\nval dataStream = KafkaUtils.createDirectStream[String,String](\n      sc,LocationStrategies.PreferConsistent,\n      ConsumerStrategies.Subscribe[String,String](topic1, kafkaParams))\n\n// 报警规则数据:P001,10,1,1(pointKey,max,min,isRemove)\nval broadCastStream = KafkaUtils.createDirectStream[String,String](\n    sc,LocationStrategies.PreferConsistent,\n    ConsumerStrategies.Subscribe[String,String](topic2, kafkaParams))\n\n// 首次加载所有数据\nvar broadCastDomainMap = sc.sparkContext.broadcast(InitDomainMap)\n\n// 对broadCastStream监测点报警规则进行广播\nbroadCastStream.foreachRDD(rdd=>{\n  // 获取当前广播值\n  val mapData = broadCastDomainMap.value\n  // 删除广播\n  broadCastDomainMap.unpersist()\n  // 获取规则流中的数据，转为map\n  val streamingMap = rdd.map(line => {\n    val lines = line.value().split(",")\n    (lines(0), new MonitorPoint(lines(0), lines(1).toLong, lines(2).toLong, lines.length >= 4 && lines(3).equals("1")))\n  }).collect().toMap\n  // 表示已删除的规则，移除广播。\n  val removeKeys = streamingMap.filter(_._2.isRemove).map(_._1).toList\n  val broadcastData = mapData.filter(line => !removeKeys.contains(line._1)) ++ (streamingMap.filter(!_._2.isRemove))\n  // 重新进行广播\n  broadCastDomainMap = rdd.sparkContext.broadcast(broadcastData)\n})\n\n// 监测数据和报警规则关联\ndataStream.map(line=>{\n  val lines = line.value().split(",")\n  val value = broadCastDomainMap.value\n  (lines(0),lines(1),value.get(lines(0)))\n}).print()\n\n  /**\n   * 第一次加载所有数据\n   */\n  def InitDomainMap:Map[String,MonitorPoint] = {\n    val map = Map(\n      "P001" -> new MonitorPoint("P001",10,1,false),\n      "P002" -> new MonitorPoint("P002",10,1,false)\n    )\n    map\n  }\n')])]),a._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[a._v("1")]),n("br"),n("span",{staticClass:"line-number"},[a._v("2")]),n("br"),n("span",{staticClass:"line-number"},[a._v("3")]),n("br"),n("span",{staticClass:"line-number"},[a._v("4")]),n("br"),n("span",{staticClass:"line-number"},[a._v("5")]),n("br"),n("span",{staticClass:"line-number"},[a._v("6")]),n("br"),n("span",{staticClass:"line-number"},[a._v("7")]),n("br"),n("span",{staticClass:"line-number"},[a._v("8")]),n("br"),n("span",{staticClass:"line-number"},[a._v("9")]),n("br"),n("span",{staticClass:"line-number"},[a._v("10")]),n("br"),n("span",{staticClass:"line-number"},[a._v("11")]),n("br"),n("span",{staticClass:"line-number"},[a._v("12")]),n("br"),n("span",{staticClass:"line-number"},[a._v("13")]),n("br"),n("span",{staticClass:"line-number"},[a._v("14")]),n("br"),n("span",{staticClass:"line-number"},[a._v("15")]),n("br"),n("span",{staticClass:"line-number"},[a._v("16")]),n("br"),n("span",{staticClass:"line-number"},[a._v("17")]),n("br"),n("span",{staticClass:"line-number"},[a._v("18")]),n("br"),n("span",{staticClass:"line-number"},[a._v("19")]),n("br"),n("span",{staticClass:"line-number"},[a._v("20")]),n("br"),n("span",{staticClass:"line-number"},[a._v("21")]),n("br"),n("span",{staticClass:"line-number"},[a._v("22")]),n("br"),n("span",{staticClass:"line-number"},[a._v("23")]),n("br"),n("span",{staticClass:"line-number"},[a._v("24")]),n("br"),n("span",{staticClass:"line-number"},[a._v("25")]),n("br"),n("span",{staticClass:"line-number"},[a._v("26")]),n("br"),n("span",{staticClass:"line-number"},[a._v("27")]),n("br"),n("span",{staticClass:"line-number"},[a._v("28")]),n("br"),n("span",{staticClass:"line-number"},[a._v("29")]),n("br"),n("span",{staticClass:"line-number"},[a._v("30")]),n("br"),n("span",{staticClass:"line-number"},[a._v("31")]),n("br"),n("span",{staticClass:"line-number"},[a._v("32")]),n("br"),n("span",{staticClass:"line-number"},[a._v("33")]),n("br"),n("span",{staticClass:"line-number"},[a._v("34")]),n("br"),n("span",{staticClass:"line-number"},[a._v("35")]),n("br"),n("span",{staticClass:"line-number"},[a._v("36")]),n("br"),n("span",{staticClass:"line-number"},[a._v("37")]),n("br"),n("span",{staticClass:"line-number"},[a._v("38")]),n("br"),n("span",{staticClass:"line-number"},[a._v("39")]),n("br"),n("span",{staticClass:"line-number"},[a._v("40")]),n("br"),n("span",{staticClass:"line-number"},[a._v("41")]),n("br"),n("span",{staticClass:"line-number"},[a._v("42")]),n("br"),n("span",{staticClass:"line-number"},[a._v("43")]),n("br"),n("span",{staticClass:"line-number"},[a._v("44")]),n("br"),n("span",{staticClass:"line-number"},[a._v("45")]),n("br"),n("span",{staticClass:"line-number"},[a._v("46")]),n("br"),n("span",{staticClass:"line-number"},[a._v("47")]),n("br"),n("span",{staticClass:"line-number"},[a._v("48")]),n("br")])]),n("h4",{attrs:{id:"flink"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#flink"}},[a._v("#")]),a._v(" Flink")]),a._v(" "),n("ul",[n("li",[a._v("flink广播变量支持增量更新到State")])]),a._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[a._v('// 存储维度信息\nMapStateDescriptor<String, AlarmParam> alarmData = \n  \t\t\t\t\t\t\t\tnew MapStateDescriptor<String,AlarmParam>(\n                                                  "alarmData", \n                                                  Types.STRING,\n                                                  Types.POJO(AlarmParam.class)\n                                                );\n// kafka数据流\nDataStreamSource<String> dataStreamSource = env.addSource(flinkKafkaConsumer010);\n\n// 报警数据流\nDataStreamSource<String> broadcastStreamSource = env.addSource(broadcastStream);\n\n// 处理函数\nBroadcastProcessFunction processFunction = \n  new BroadcastProcessFunction<String, String, Tuple3<String, Long, AlarmParam>>() {\n        @Override\n        public void processElement(String value, ReadOnlyContext ctx, Collector out){\n          String[] split = value.split(",");\n          // 获取广播数据\n          ReadOnlyBroadcastState broadcastState = ctx.getBroadcastState(alarmData);\n          out.collect(1,2,broadcastState.get(1)); // 关联数据\n        }\n\n        @Override\n        public void processBroadcastElement(String value, Context ctx, Collector out){\n          BroadcastState broadcastState = ctx.getBroadcastState(alarmData);\n          String[] split = value.split(",");\n          boolean isRemove = split[3].equals("1");\n          if (split.length >= 4 && !isRemove) {\n            // 增量更新数据\n            broadcastState.put(split[0], new AlarmParam(1,2,3,4));\n          } else {\n            // 已删除数据从广播去除\n            broadcastState.remove(split[0]);\n          }\n        }\n      };\n\n        SingleOutputStreamOperatorresult = dataStreamSource\n                .connect(broadcastStreamSource.broadcast(alarmData))\n                .process(processFunction);\n        result.print();\n')])]),a._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[a._v("1")]),n("br"),n("span",{staticClass:"line-number"},[a._v("2")]),n("br"),n("span",{staticClass:"line-number"},[a._v("3")]),n("br"),n("span",{staticClass:"line-number"},[a._v("4")]),n("br"),n("span",{staticClass:"line-number"},[a._v("5")]),n("br"),n("span",{staticClass:"line-number"},[a._v("6")]),n("br"),n("span",{staticClass:"line-number"},[a._v("7")]),n("br"),n("span",{staticClass:"line-number"},[a._v("8")]),n("br"),n("span",{staticClass:"line-number"},[a._v("9")]),n("br"),n("span",{staticClass:"line-number"},[a._v("10")]),n("br"),n("span",{staticClass:"line-number"},[a._v("11")]),n("br"),n("span",{staticClass:"line-number"},[a._v("12")]),n("br"),n("span",{staticClass:"line-number"},[a._v("13")]),n("br"),n("span",{staticClass:"line-number"},[a._v("14")]),n("br"),n("span",{staticClass:"line-number"},[a._v("15")]),n("br"),n("span",{staticClass:"line-number"},[a._v("16")]),n("br"),n("span",{staticClass:"line-number"},[a._v("17")]),n("br"),n("span",{staticClass:"line-number"},[a._v("18")]),n("br"),n("span",{staticClass:"line-number"},[a._v("19")]),n("br"),n("span",{staticClass:"line-number"},[a._v("20")]),n("br"),n("span",{staticClass:"line-number"},[a._v("21")]),n("br"),n("span",{staticClass:"line-number"},[a._v("22")]),n("br"),n("span",{staticClass:"line-number"},[a._v("23")]),n("br"),n("span",{staticClass:"line-number"},[a._v("24")]),n("br"),n("span",{staticClass:"line-number"},[a._v("25")]),n("br"),n("span",{staticClass:"line-number"},[a._v("26")]),n("br"),n("span",{staticClass:"line-number"},[a._v("27")]),n("br"),n("span",{staticClass:"line-number"},[a._v("28")]),n("br"),n("span",{staticClass:"line-number"},[a._v("29")]),n("br"),n("span",{staticClass:"line-number"},[a._v("30")]),n("br"),n("span",{staticClass:"line-number"},[a._v("31")]),n("br"),n("span",{staticClass:"line-number"},[a._v("32")]),n("br"),n("span",{staticClass:"line-number"},[a._v("33")]),n("br"),n("span",{staticClass:"line-number"},[a._v("34")]),n("br"),n("span",{staticClass:"line-number"},[a._v("35")]),n("br"),n("span",{staticClass:"line-number"},[a._v("36")]),n("br"),n("span",{staticClass:"line-number"},[a._v("37")]),n("br"),n("span",{staticClass:"line-number"},[a._v("38")]),n("br"),n("span",{staticClass:"line-number"},[a._v("39")]),n("br"),n("span",{staticClass:"line-number"},[a._v("40")]),n("br"),n("span",{staticClass:"line-number"},[a._v("41")]),n("br"),n("span",{staticClass:"line-number"},[a._v("42")]),n("br"),n("span",{staticClass:"line-number"},[a._v("43")]),n("br")])])])}),[],!1,null,null,null);s.default=e.exports}}]);