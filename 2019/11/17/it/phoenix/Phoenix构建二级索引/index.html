<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="天行健、君子以自强不息；地势坤，君子以厚德载物。">
    <meta name="keyword"  content="兰草">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
        Phoenix构建二级索引 - Kaffir Lily的博客 | Kaffir Lily&#39;s Blog
        
    </title>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/aircloud.css">
    <link rel="stylesheet" href="/css/gitment.css">
    <link rel="stylesheet" href="//at.alicdn.com/t/font_1598291_q3el2wqimj.css" type="text/css">
    <link href="//at.alicdn.com/t/font_620856_pl6z7sid89qkt9.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
</head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i> 君子谦谦，温和有礼，有才而不骄，得志而不傲，居于谷而不卑。 </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar ">
            <img src="/img/avatar.jpg" />
        </div>
        <div class="name">
            <i>kfly</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li >
                <a href="/">
                    <i class="iconfont iconhome"></i>
                    <span>主页</span>
                </a>
            </li>
 	   <li >
                <a href="/spec/">
                    <i class="iconfont iconzhuanti"></i>
                    <span>专题</span>
                </a>
            </li>
            <li >
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>标签</span>
                </a>
            </li>
            <li >
                <a href="/archive">
                    <i class="iconfont icon-guidang2"></i>
                    <span>存档</span>
                </a>
            </li>
            <li >
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>简历</span>
                </a>
            </li>
            
            <li>
                <a id="search">
                    <i class="iconfont icon-sousuo1"></i>
                    <span>搜索</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Phoenix构建二级索引"><span class="toc-text">Phoenix构建二级索引</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1、为什么需要用二级索引？"><span class="toc-text">1、为什么需要用二级索引？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2、Phoenix-Global-Indexing-And-Local-Indexing"><span class="toc-text">2、Phoenix Global Indexing And Local Indexing</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-Global-Indexing"><span class="toc-text">2.1 Global Indexing</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-Local-Indexing"><span class="toc-text">2.2 Local Indexing</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-Immutable-index-And-Mutable-index"><span class="toc-text">3 Immutable index And Mutable index</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-immutable-index"><span class="toc-text">3.1 immutable index</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-mutable-index"><span class="toc-text">3.2 mutable index</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4、配置HBase支持Phoenix二级索引"><span class="toc-text">4、配置HBase支持Phoenix二级索引</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-修改配置文件"><span class="toc-text">4.1 修改配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-重启hbase"><span class="toc-text">4.2 重启hbase</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5、实战"><span class="toc-text">5、实战</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-在phoenix中创建表"><span class="toc-text">5.1 在phoenix中创建表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-导入测试数据"><span class="toc-text">5.2 导入测试数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3-Global-Indexing的二级索引测试"><span class="toc-text">5.3 Global Indexing的二级索引测试</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#5-3-1-正常查询一条数据所需的时间"><span class="toc-text">5.3.1 正常查询一条数据所需的时间</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-3-2-给表USER创建基于Global-Indexing的二级索引"><span class="toc-text">5.3.2 给表USER创建基于Global Indexing的二级索引</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-3-3-以下查询不会用到索引表"><span class="toc-text">5.3.3 以下查询不会用到索引表</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-4-Local-Indexing的二级索引测试"><span class="toc-text">5.4  Local Indexing的二级索引测试</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#5-4-1-正常查询一条数据所需的时间"><span class="toc-text">5.4.1 正常查询一条数据所需的时间</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-4-2-给表USER创建基于Local-Indexing的二级索引"><span class="toc-text">5.4.2 给表USER创建基于Local Indexing的二级索引</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-5-如何确保query查询使用Index"><span class="toc-text">5.5 如何确保query查询使用Index</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#5-5-1-创建-convered-index"><span class="toc-text">5.5.1  创建 convered index</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-5-2-在查询中提示其使用index"><span class="toc-text">5.5.2 在查询中提示其使用index</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-5-3-使用本地索引-创建Local-Indexing-索引"><span class="toc-text">5.5.3 使用本地索引 (创建Local Indexing 索引)</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-6-索引重建"><span class="toc-text">5.6 索引重建</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-7-删除索引"><span class="toc-text">5.7 删除索引</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6、索引性能调优"><span class="toc-text">6、索引性能调优</span></a></li></ol></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input"/>
            <span id="begin-search">搜索</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>

        <div class="index-about-mobile">
            <i> 君子谦谦，温和有礼，有才而不骄，得志而不傲，居于谷而不卑。 </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        Phoenix构建二级索引
    </div>

    <div class="post-meta">
        <span class="attr">发布于：<span>2019-11-17 18:44:51</span></span>
        
        <span class="attr">标签：/
        
        <a class="tag" href="/tags/#phoenix" title="phoenix">phoenix</a>
        <span>/</span>
        
        <a class="tag" href="/tags/#二级索引" title="二级索引">二级索引</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">访问：<span id="busuanzi_value_page_pv"></span>
</span>
</span>
    </div>
    <div class="post-content ">
        <h2 id="Phoenix构建二级索引"><a href="#Phoenix构建二级索引" class="headerlink" title="Phoenix构建二级索引"></a>Phoenix构建二级索引</h2><h3 id="1、为什么需要用二级索引？"><a href="#1、为什么需要用二级索引？" class="headerlink" title="1、为什么需要用二级索引？"></a>1、为什么需要用二级索引？</h3><ul>
<li>对于HBase而言，如果想精确地定位到某行记录，唯一的办法是通过rowkey来查询。如果不通过rowkey来查找数据，就必须逐行地比较每一列的值，即全表扫瞄。</li>
<li>对于较大的表，全表扫描的代价是不可接受的。但是，很多情况下，需要从多个角度查询数据。例如，在定位某个人的时候，可以通过姓名、身份证号、学籍号等不同的角度来查询，要想把这么多角度的数据都放到rowkey中几乎不可能（业务的灵活性不允许，对rowkey长度的要求也不允许）。所以需要secondary index（二级索引）来完成这件事。secondary index的原理很简单，但是如果自己维护的话则会麻烦一些。现在，Phoenix已经提供了对HBase secondary index的支持。</li>
</ul>
<h3 id="2、Phoenix-Global-Indexing-And-Local-Indexing"><a href="#2、Phoenix-Global-Indexing-And-Local-Indexing" class="headerlink" title="2、Phoenix Global Indexing And Local Indexing"></a>2、Phoenix Global Indexing And Local Indexing</h3><h4 id="2-1-Global-Indexing"><a href="#2-1-Global-Indexing" class="headerlink" title="2.1 Global Indexing"></a>2.1 Global Indexing</h4><ul>
<li>Global indexing，全局索引，适用于读多写少的业务场景。</li>
<li>使用Global indexing在写数据的时候开销很大，因为所有对数据表的更新操作（DELETE, UPSERT VALUES and UPSERT SELECT），都会引起索引表的更新，而索引表是分布在不同的数据节点上的，跨节点的数据传输带来了较大的性能消耗。</li>
<li>在读数据的时候Phoenix会选择索引表来降低查询消耗的时间。在默认情况下如果想查询的字段不是索引字段的话索引表不会被使用，也就是说不会带来查询速度的提升。</li>
</ul>
<h4 id="2-2-Local-Indexing"><a href="#2-2-Local-Indexing" class="headerlink" title="2.2 Local Indexing"></a>2.2 Local Indexing</h4><ul>
<li>Local indexing，本地索引，适用于写操作频繁以及空间受限制的场景。</li>
<li>与Global indexing一样，Phoenix会自动判定在进行查询的时候是否使用索引。使用Local indexing时，索引数据和数据表的数据存放在相同的服务器中，这样避免了在写操作的时候往不同服务器的索引表中写索引带来的额外开销。使用Local indexing的时候即使查询的字段不是索引字段索引表也会被使用，这会带来查询速度的提升，这点跟Global indexing不同。对于Local Indexing，一个数据表的所有索引数据都存储在一个单一的独立的可共享的表中</li>
</ul>
<h3 id="3-Immutable-index-And-Mutable-index"><a href="#3-Immutable-index-And-Mutable-index" class="headerlink" title="3 Immutable index And Mutable index"></a>3 Immutable index And Mutable index</h3><h4 id="3-1-immutable-index"><a href="#3-1-immutable-index" class="headerlink" title="3.1 immutable index"></a>3.1 immutable index</h4><ul>
<li>immutable index，不可变索引，适用于数据只增加不更新并且按照时间先后顺序存储（time-series data）的场景，如保存日志数据或者事件数据等。</li>
<li>不可变索引的存储方式是write one，append only。当在Phoenix使用create table语句时指定IMMUTABLE_ROWS = true表示该表上创建的索引将被设置为不可变索引。Phoenix默认情况下如果在create table时不指定IMMUTABLE_ROW = true时，表示该表为mutable。不可变索引分为Global immutable index和Local immutable index两种。</li>
</ul>
<h4 id="3-2-mutable-index"><a href="#3-2-mutable-index" class="headerlink" title="3.2 mutable index"></a>3.2 mutable index</h4><ul>
<li>mutable index，可变索引，适用于数据有增删改的场景。</li>
<li>Phoenix默认情况创建的索引都是可变索引，除非在create table的时候显式地指定IMMUTABLE_ROWS = true。可变索引同样分为Global immutable index和Local immutable index两种。</li>
</ul>
<h3 id="4、配置HBase支持Phoenix二级索引"><a href="#4、配置HBase支持Phoenix二级索引" class="headerlink" title="4、配置HBase支持Phoenix二级索引"></a>4、配置HBase支持Phoenix二级索引</h3><h4 id="4-1-修改配置文件"><a href="#4-1-修改配置文件" class="headerlink" title="4.1 修改配置文件"></a>4.1 修改配置文件</h4><ul>
<li><p>如果要启用phoenix的二级索引功能，需要修改配置文件hbase-site.xml</p>
</li>
<li><p>vim hbase-site.xml      </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 添加配置 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.regionserver.wal.codec<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">value</span>&gt;</span>org.apache.hadoop.hbase.regionserver.wal.IndexedWALEditCodec<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.region.server.rpc.scheduler.factory.class<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">value</span>&gt;</span>org.apache.hadoop.hbase.ipc.PhoenixRpcSchedulerFactory<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.rpc.controllerfactory.class<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">value</span>&gt;</span>org.apache.hadoop.hbase.ipc.controller.ServerRpcControllerFactory<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="4-2-重启hbase"><a href="#4-2-重启hbase" class="headerlink" title="4.2 重启hbase"></a>4.2 重启hbase</h4><ul>
<li>完成上述修改后重启hbase集群使配置生效。</li>
</ul>
<h3 id="5、实战"><a href="#5、实战" class="headerlink" title="5、实战"></a>5、实战</h3><h4 id="5-1-在phoenix中创建表"><a href="#5-1-在phoenix中创建表" class="headerlink" title="5.1 在phoenix中创建表"></a>5.1 在phoenix中创建表</h4><ul>
<li><p>首先，在phoenix中创建一个user table</p>
</li>
<li><p>node02执行以下命令，进入phoenix客户端</p>
</li>
</ul>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd <span class="regexp">/kfly/</span>install<span class="regexp">/apache-phoenix-4.14.0-cdh5.14.2-bin/</span></span><br><span class="line">bin/sqlline.py <span class="string">node01:</span><span class="number">2181</span></span><br></pre></td></tr></table></figure>
<ul>
<li>创建表</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span>  <span class="keyword">table</span> <span class="keyword">user</span> (</span><br><span class="line"><span class="string">"session_id"</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">not</span> <span class="literal">null</span> primary <span class="keyword">key</span>, </span><br><span class="line"><span class="string">"f"</span>.<span class="string">"cookie_id"</span> <span class="built_in">varchar</span>(<span class="number">100</span>), </span><br><span class="line"><span class="string">"f"</span>.<span class="string">"visit_time"</span> <span class="built_in">varchar</span>(<span class="number">100</span>), </span><br><span class="line"><span class="string">"f"</span>.<span class="string">"user_id"</span> <span class="built_in">varchar</span>(<span class="number">100</span>), </span><br><span class="line"><span class="string">"f"</span>.<span class="string">"age"</span> <span class="built_in">varchar</span>(<span class="number">100</span>), </span><br><span class="line"><span class="string">"f"</span>.<span class="string">"sex"</span> <span class="built_in">varchar</span>(<span class="number">100</span>), </span><br><span class="line"><span class="string">"f"</span>.<span class="string">"visit_url"</span> <span class="built_in">varchar</span>(<span class="number">100</span>), </span><br><span class="line"><span class="string">"f"</span>.<span class="string">"visit_os"</span> <span class="built_in">varchar</span>(<span class="number">100</span>), </span><br><span class="line"><span class="string">"f"</span>.<span class="string">"browser_name"</span> <span class="built_in">varchar</span>(<span class="number">100</span>),</span><br><span class="line"><span class="string">"f"</span>.<span class="string">"visit_ip"</span> <span class="built_in">varchar</span>(<span class="number">100</span>), </span><br><span class="line"><span class="string">"f"</span>.<span class="string">"province"</span> <span class="built_in">varchar</span>(<span class="number">100</span>),</span><br><span class="line"><span class="string">"f"</span>.<span class="string">"city"</span> <span class="built_in">varchar</span>(<span class="number">100</span>),</span><br><span class="line"><span class="string">"f"</span>.<span class="string">"page_id"</span> <span class="built_in">varchar</span>(<span class="number">100</span>), </span><br><span class="line"><span class="string">"f"</span>.<span class="string">"goods_id"</span> <span class="built_in">varchar</span>(<span class="number">100</span>),</span><br><span class="line"><span class="string">"f"</span>.<span class="string">"shop_id"</span> <span class="built_in">varchar</span>(<span class="number">100</span>)) column_encoded_bytes=<span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<h4 id="5-2-导入测试数据"><a href="#5-2-导入测试数据" class="headerlink" title="5.2 导入测试数据"></a>5.2 导入测试数据</h4><ul>
<li>将课件当中的user50w.csv 这个文件上传到node02的/kkb/install/phoenixsql 这个路径下<br>该CSV文件中有250万条记录<br>node02执行以下命令，导入50W的测试数据</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /kkb/install/apache-phoenix-4.14.0-cdh5.14.2-bin/</span><br><span class="line">bin/psql.py -t USER node01:2181 /kkb/install/phoenixsql/user50w.csv</span><br></pre></td></tr></table></figure>
<h4 id="5-3-Global-Indexing的二级索引测试"><a href="#5-3-Global-Indexing的二级索引测试" class="headerlink" title="5.3 Global Indexing的二级索引测试"></a>5.3 Global Indexing的二级索引测试</h4><h5 id="5-3-1-正常查询一条数据所需的时间"><a href="#5-3-1-正常查询一条数据所需的时间" class="headerlink" title="5.3.1 正常查询一条数据所需的时间"></a>5.3.1 正常查询一条数据所需的时间</h5><ul>
<li>在为表USER创建secondary index之前，先看看查询一条数据所需的时间<br>在node02服务器，进入phoenix的客户端</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bin/sqlline.py node01:2181</span><br><span class="line">cd /kkb/install/apache-phoenix-4.14.0-cdh5.14.2-bin</span><br></pre></td></tr></table></figure>
<ul>
<li><p>然后执行以下sql语句，查询数据，查看耗费时间</p>
<p>可以看到，对名为cookie_id的列进行按值查询需要10秒左右。</p>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> <span class="string">"cookie_id"</span> = <span class="string">'99738fd1-2084-44e9'</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>我们可以通过explain来查看执行计划<br>EXPLAIN(语句的执行逻辑及计划):</p>
<p>由图看知先进行了全表扫描再通过过滤器来筛选出目标数据，显示这种查询方式效率是很低的。</p>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> <span class="string">"cookie_id"</span> = <span class="string">'99738fd1-2084-44e9'</span>;</span><br></pre></td></tr></table></figure>
<h5 id="5-3-2-给表USER创建基于Global-Indexing的二级索引"><a href="#5-3-2-给表USER创建基于Global-Indexing的二级索引" class="headerlink" title="5.3.2 给表USER创建基于Global Indexing的二级索引"></a>5.3.2 给表USER创建基于Global Indexing的二级索引</h5><ul>
<li><p>进入到phoenix的客户端，然后执行以下命令进行创建索引<br>在cookie_id列上面创建二级索引：</p>
<p>查看当前所有表会发现多一张USER_COOKIE_ID_INDEX索引表，查询该表数据。</p>
</li>
</ul>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0: jdbc:phoenix:node01:2181&gt; create index USER_COOKIE_ID_INDEX on<span class="built_in"> USER </span>(<span class="string">"f"</span>.<span class="string">"cookie_id"</span>);</span><br></pre></td></tr></table></figure>
<p><img src="https://kfly.top/picture/kfly-top/Phoenix构建二级索引/assets/user_cookie_id_index.PNG" alt=""></p>
<ul>
<li><p>再次执行查询”cookie_id”=’99738fd1-2084-44e9’的数据记录</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="string">"cookie_id"</span> <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> <span class="string">"cookie_id"</span> = <span class="string">'99738fd1-2084-44e9'</span>;</span><br></pre></td></tr></table></figure>
<p><img src="https://kfly.top/picture/kfly-top/Phoenix构建二级索引/assets/3.PNG" alt=""></p>
<p>此时：查询速度由10秒左右减少到了毫秒级别。</p>
<p>注意：select所带的字段必须包含在覆盖索引内</p>
<p>EXPLAIN(语句的执行逻辑及计划):</p>
<p>可以看到使用到了创建的索引USER_COOKIE_ID_INDEX。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> <span class="string">"cookie_id"</span> <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> <span class="string">"cookie_id"</span>=<span class="string">'99738fd1-2084-44e9'</span>;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>  <img src="https://kfly.top/picture/kfly-top/Phoenix构建二级索引/assets/4.PNG" alt="">    </p>
<h5 id="5-3-3-以下查询不会用到索引表"><a href="#5-3-3-以下查询不会用到索引表" class="headerlink" title="5.3.3 以下查询不会用到索引表"></a>5.3.3 以下查询不会用到索引表</h5>  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="string">"cookie_id"</span>,<span class="string">"age"</span> <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> <span class="string">"cookie_id"</span>=<span class="string">'99738fd1-2084-44e9'</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>(虽然cookie_id是索引字段，但age不是索引字段，所以不会使用到索引)<br>  也可以通过EXPLAIN查询语句的执行逻辑及计划</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">EXPLAIN</span>	<span class="keyword">select</span> <span class="string">"cookie_id"</span>,<span class="string">"age"</span> <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> <span class="string">"cookie_id"</span>=<span class="string">'99738fd1-2084-44e9'</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>同理要查询的字段不是索引字段，也不会使用到索引表。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="string">"sex"</span> <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> <span class="string">"cookie_id"</span>=<span class="string">'99738fd1-2084-44e9'</span>;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="5-4-Local-Indexing的二级索引测试"><a href="#5-4-Local-Indexing的二级索引测试" class="headerlink" title="5.4  Local Indexing的二级索引测试"></a>5.4  Local Indexing的二级索引测试</h4><h5 id="5-4-1-正常查询一条数据所需的时间"><a href="#5-4-1-正常查询一条数据所需的时间" class="headerlink" title="5.4.1 正常查询一条数据所需的时间"></a>5.4.1 正常查询一条数据所需的时间</h5><ul>
<li>在为表USER创建secondary index之前，先看看查询一条数据所需的时间</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> <span class="string">"user_id"</span>=<span class="string">'371e963d-c-487065'</span>;</span><br></pre></td></tr></table></figure>
<p>可以看到，对名为user_id的列进行按值查询需要11秒左右。</p>
<ul>
<li>EXPLAIN(语句的执行逻辑及计划):</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> <span class="string">"user_id"</span>=<span class="string">'371e963d-c-487065'</span>;</span><br></pre></td></tr></table></figure>
<p>由图看知先进行了全表扫描再通过过滤器来筛选出目标数据，显示这种查询方式效率是很低的。</p>
<h5 id="5-4-2-给表USER创建基于Local-Indexing的二级索引"><a href="#5-4-2-给表USER创建基于Local-Indexing的二级索引" class="headerlink" title="5.4.2 给表USER创建基于Local Indexing的二级索引"></a>5.4.2 给表USER创建基于Local Indexing的二级索引</h5><ul>
<li>在user_id列上面创建二级索引：</li>
</ul>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create local index USER_USER_ID_INDEX on<span class="built_in"> USER </span>(<span class="string">"f"</span>.<span class="string">"user_id"</span>);</span><br></pre></td></tr></table></figure>
<p>查看当前所有表会发现多一张USER_USER_ID_INDEX索引表，查询该表数据。</p>
<ul>
<li><p>再次执行查询”user_id”=’371e963d-c-487065’的数据记录</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> <span class="string">"user_id"</span>=<span class="string">'371e963d-c-487065'</span>;</span><br><span class="line">  可以看到，对名为user_id的列进行按值查询需要0.3秒左右。</span><br></pre></td></tr></table></figure>
</li>
<li><p>EXPLAIN(语句的执行逻辑及计划):</p>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> <span class="string">"user_id"</span>=<span class="string">'371e963d-c-487065'</span>;</span><br></pre></td></tr></table></figure>
<p>查看执行计划，没有执行全表扫描，效率更高了</p>
<p>此时：查询速度由11秒左右减少到了毫秒级别。</p>
<p>EXPLAIN(语句的执行逻辑及计划):</p>
  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> <span class="string">"user_id"</span>,<span class="string">"age"</span>,<span class="string">"sex"</span> <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> <span class="string">"user_id"</span>=<span class="string">'371e963d-c-487065'</span>;</span><br></pre></td></tr></table></figure>
<p>可以看到使用到了创建的索引USER_USER_ID_INDEX.</p>
<h4 id="5-5-如何确保query查询使用Index"><a href="#5-5-如何确保query查询使用Index" class="headerlink" title="5.5 如何确保query查询使用Index"></a>5.5 如何确保query查询使用Index</h4><p>​    要想让一个查询使用index，有三种方式实现。</p>
<h5 id="5-5-1-创建-convered-index"><a href="#5-5-1-创建-convered-index" class="headerlink" title="5.5.1  创建 convered index"></a>5.5.1  创建 convered index</h5><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">如果在某次查询中，查询项或者查询条件中包含除被索引列之外的列（主键MY_PK除外）。默认情况下，该查询会触发full table scan（全表扫描），但是使用covered index则可以避免全表扫描。 </span><br><span class="line">创建包含某个字段的覆盖索引,创建方式如下：</span><br><span class="line"> create index USER_COOKIE_ID_AGE_INDEX on<span class="built_in"> USER </span>(<span class="string">"f"</span>.<span class="string">"cookie_id"</span>) include(<span class="string">"f"</span>.<span class="string">"age"</span>);</span><br><span class="line"> </span><br><span class="line"> 查看当前所有表会发现多一张USER_COOKIE_ID_AGE_INDEX索引表，查询该表数据。</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">查询数据</span><br><span class="line"><span class="keyword">select</span> <span class="string">"age"</span> <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span>  <span class="string">"cookie_id"</span>=<span class="string">'99738fd1-2084-44e9'</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="string">"age"</span>,<span class="string">"sex"</span> <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span>  <span class="string">"cookie_id"</span>=<span class="string">'99738fd1-2084-44e9'</span>;</span><br></pre></td></tr></table></figure>
<p><img src="https://kfly.top/picture/kfly-top/Phoenix构建二级索引/assets/16.PNG" alt=""></p>
<p><img src="https://kfly.top/picture/kfly-top/Phoenix构建二级索引/assets/17.PNG" alt=""></p>
<h5 id="5-5-2-在查询中提示其使用index"><a href="#5-5-2-在查询中提示其使用index" class="headerlink" title="5.5.2 在查询中提示其使用index"></a>5.5.2 在查询中提示其使用index</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">在<span class="keyword">select</span>和column_name之间加上<span class="comment">/*+ Index(&lt;表名&gt; &lt;index名&gt;)*/</span>，通过这种方式强制使用索引。</span><br><span class="line">例如：</span><br><span class="line"><span class="keyword">select</span> <span class="comment">/*+ index(user,USER_COOKIE_ID_AGE_INDEX) */</span> <span class="string">"age"</span> <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> <span class="string">"cookie_id"</span>=<span class="string">'99738fd1-2084-44e9'</span>;</span><br><span class="line"></span><br><span class="line">如果sex是索引字段，那么就会直接从索引表中查询</span><br><span class="line">如果sex不是索引字段，那么将会进行全表扫描，所以当用户明确知道表中数据较少且符合检索条件时才适用，此时的性能才是最佳的。</span><br></pre></td></tr></table></figure>
<p><img src="https://kfly.top/picture/kfly-top/Phoenix构建二级索引/assets/18.PNG" alt=""></p>
<p><img src="https://kfly.top/picture/kfly-top/Phoenix构建二级索引/assets/19.PNG" alt=""></p>
<h5 id="5-5-3-使用本地索引-创建Local-Indexing-索引"><a href="#5-5-3-使用本地索引-创建Local-Indexing-索引" class="headerlink" title="5.5.3 使用本地索引 (创建Local Indexing 索引)"></a>5.5.3 使用本地索引 (创建Local Indexing 索引)</h5><ul>
<li>详细见上面</li>
</ul>
<h4 id="5-6-索引重建"><a href="#5-6-索引重建" class="headerlink" title="5.6 索引重建"></a>5.6 索引重建</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Phoenix的索引重建是把索引表清空后重新装配数据。</span><br><span class="line">alter index USER_COOKIE_ID_INDEX on<span class="built_in"> user </span>rebuild;</span><br></pre></td></tr></table></figure>
<h4 id="5-7-删除索引"><a href="#5-7-删除索引" class="headerlink" title="5.7 删除索引"></a>5.7 删除索引</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">删除某个表的某张索引：</span><br><span class="line">语法	drop index 索引名称 on 表名</span><br><span class="line">例如：  </span><br><span class="line">drop index USER_COOKIE_ID_INDEX on user;</span><br><span class="line"></span><br><span class="line">如果表中的一个索引列被删除，则索引也将被自动删除，如果删除的是</span><br><span class="line">覆盖索引上的列，则此列将从覆盖索引中被自动删除。</span><br></pre></td></tr></table></figure>
<h3 id="6、索引性能调优"><a href="#6、索引性能调优" class="headerlink" title="6、索引性能调优"></a>6、索引性能调优</h3><p>​    一般来说，索引已经很快了，不需要特别的优化。这里也提供了一些方法，让你在面对特定的环境和负载的时候可以进行一些调优。下面的这些需要在hbase-site.xml文件中设置，针对所有的服务器。</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>. index<span class="selector-class">.builder</span><span class="selector-class">.threads</span><span class="selector-class">.max</span> </span><br><span class="line">创建索引时，使用的最大线程数。 </span><br><span class="line">默认值: <span class="number">10</span>。</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>. index<span class="selector-class">.builder</span><span class="selector-class">.threads</span><span class="selector-class">.keepalivetime</span> </span><br><span class="line">创建索引的创建线程池中线程的存活时间，单位：秒。 </span><br><span class="line">默认值: <span class="number">60</span></span><br><span class="line"></span><br><span class="line"><span class="number">3</span>. index<span class="selector-class">.writer</span><span class="selector-class">.threads</span><span class="selector-class">.max</span> </span><br><span class="line">写索引表数据的写线程池的最大线程数。 </span><br><span class="line">更新索引表可以用的最大线程数，也就是同时可以更新多少张索引表，数量最好和索引表的数量一致。 </span><br><span class="line">默认值: <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="number">4</span>. index<span class="selector-class">.writer</span><span class="selector-class">.threads</span><span class="selector-class">.keepalivetime</span> </span><br><span class="line">索引写线程池中，线程的存活时间，单位：秒。</span><br><span class="line">默认值：<span class="number">60</span></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="number">5</span>. hbase<span class="selector-class">.htable</span><span class="selector-class">.threads</span><span class="selector-class">.max</span> </span><br><span class="line">每一张索引表可用于写的线程数。 </span><br><span class="line">默认值: <span class="number">2</span>,<span class="number">147</span>,<span class="number">483</span>,<span class="number">647</span></span><br><span class="line"></span><br><span class="line"><span class="number">6</span>. hbase<span class="selector-class">.htable</span><span class="selector-class">.threads</span><span class="selector-class">.keepalivetime</span> </span><br><span class="line">索引表线程池中线程的存活时间，单位：秒。 </span><br><span class="line">默认值: <span class="number">60</span></span><br><span class="line"></span><br><span class="line"><span class="number">7</span>. index<span class="selector-class">.tablefactory</span><span class="selector-class">.cache</span><span class="selector-class">.size</span> </span><br><span class="line">允许缓存的索引表的数量。 </span><br><span class="line">增加此值，可以在写索引表时不用每次都去重复的创建htable，这个值越大，内存消耗越多。 </span><br><span class="line">默认值: <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="number">8</span>. org<span class="selector-class">.apache</span><span class="selector-class">.phoenix</span><span class="selector-class">.regionserver</span><span class="selector-class">.index</span><span class="selector-class">.handler</span><span class="selector-class">.count</span> </span><br><span class="line">处理全局索引写请求时，可以使用的线程数。 </span><br><span class="line">默认值: <span class="number">30</span></span><br></pre></td></tr></table></figure>

        
        <br />
        <div id="comment-container">
        </div>
        <div id="disqus_thread"></div>

        <div id="lv-container">
        </div>

    </div>
</div>

    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        

        

    </ul>
    
    <p>
        <span>/</span>
        
        <span><a href="https://blog.sev7e0.site/">大数据施工现场</a></span>
        <span>/</span>
        
        <span><a href="https://wangchujiang.com/linux-command/">linux命令行工具</a></span>
        <span>/</span>
        
    </p>
    
    <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>
        Created By <a href="https://hexo.io/">Hexo</a>  Theme <a href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a></p>
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "search.json"
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="/js/index.js"></script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<script src="/js/gitment.js"></script>
<script>
    var gitment = new Gitment({
        id: 'Phoenix构建二级索引',
        owner: 'orchid-ding',
        repo: 'kfly-blog-comment',
        oauth: {
            client_id: '0770cdab79393197b6f5',
            client_secret: '376fb6c7bcd5047718b356712f596b89e490360c',
        },
    })
    gitment.render('comment-container')
</script>




</html>
