<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="天行健、君子以自强不息；地势坤，君子以厚德载物。">
    <meta name="keyword"  content="兰草">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
        hive企业综合案例实战 - Kaffir Lily的博客 | Kaffir Lily&#39;s Blog
        
    </title>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/aircloud.css">
    <link rel="stylesheet" href="/css/gitment.css">
    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_pl6z7sid89qkt9.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
</head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i> 君子谦谦，温和有礼，有才而不骄，得志而不傲，居于谷而不卑。 </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar ">
            <img src="/img/avatar.jpg" />
        </div>
        <div class="name">
            <i>kfly</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li >
                <a href="/">
                    <i class="icon-font icon-shouye1"></i>
                    <span>主页</span>
                </a>
            </li>
 	   <li >
                <a href="/spec/">
                    <i class="icon-font icon-shouye1"></i>
                    <span>专题</span>
                </a>
            </li>
            <li >
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>标签</span>
                </a>
            </li>
            <li >
                <a href="/archive">
                    <i class="iconfont icon-guidang2"></i>
                    <span>存档</span>
                </a>
            </li>
            <li >
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>简历</span>
                </a>
            </li>
            
            <li>
                <a id="search">
                    <i class="iconfont icon-sousuo1"></i>
                    <span>搜索</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#hive的综合案例实战"><span class="toc-text">hive的综合案例实战</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1、需求描述"><span class="toc-text">1、需求描述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2、项目表字段"><span class="toc-text">2、项目表字段</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1、数据结构"><span class="toc-text">1、数据结构</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3、ETL原始数据清洗"><span class="toc-text">3、ETL原始数据清洗</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4、项目建表并加载数据"><span class="toc-text">4、项目建表并加载数据</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1、创建表"><span class="toc-text">1、创建表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2、导入ETL之后的数据"><span class="toc-text">2、导入ETL之后的数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3、向ORC表插入数据"><span class="toc-text">3、向ORC表插入数据</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5、业务分析"><span class="toc-text">5、业务分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1、统计视频观看数Top10"><span class="toc-text">1、统计视频观看数Top10</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2、统计视频类别热度Top10"><span class="toc-text">2、统计视频类别热度Top10</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3、统计出视频观看数最高的20个视频的所属类别以及类别包含Top20视频的个数"><span class="toc-text">3、统计出视频观看数最高的20个视频的所属类别以及类别包含Top20视频的个数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4、-统计视频观看数Top50所关联视频的所属类别Rank"><span class="toc-text">4、 统计视频观看数Top50所关联视频的所属类别Rank</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5、统计每个类别中的视频热度Top10，以Music为例"><span class="toc-text">5、统计每个类别中的视频热度Top10，以Music为例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6、-统计每个类别中视频流量Top10，以Music为例"><span class="toc-text">6、 统计每个类别中视频流量Top10，以Music为例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7、-统计上传视频最多的用户Top10以及他们上传的观看次数在前20的视频"><span class="toc-text">7、 统计上传视频最多的用户Top10以及他们上传的观看次数在前20的视频</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8、统计每个类别视频观看数Top10"><span class="toc-text">8、统计每个类别视频观看数Top10</span></a></li></ol></li></ol></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input"/>
            <span id="begin-search">搜索</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>

        <div class="index-about-mobile">
            <i> 君子谦谦，温和有礼，有才而不骄，得志而不傲，居于谷而不卑。 </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        hive企业综合案例实战
    </div>

    <div class="post-meta">
        <span class="attr">发布于：<span>2019-11-08 19:29:24</span></span>
        
        <span class="attr">标签：/
        
        <a class="tag" href="/tags/#hadoop" title="hadoop">hadoop</a>
        <span>/</span>
        
        <a class="tag" href="/tags/#hive" title="hive">hive</a>
        <span>/</span>
        
        <a class="tag" href="/tags/#项目练习" title="项目练习">项目练习</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">访问：<span id="busuanzi_value_page_pv"></span>
</span>
</span>
    </div>
    <div class="post-content ">
        <h1 id="hive的综合案例实战"><a href="#hive的综合案例实战" class="headerlink" title="hive的综合案例实战"></a>hive的综合案例实战</h1><h2 id="1、需求描述"><a href="#1、需求描述" class="headerlink" title="1、需求描述"></a>1、需求描述</h2><p>统计youtube影音视频网站的常规指标，各种TopN指标：</p>
<p>–统计视频观看数Top10</p>
<p>–统计视频类别热度Top10</p>
<p>–统计视频观看数Top20所属类别</p>
<p>–统计视频观看数Top50所关联视频的所属类别Rank</p>
<p>–统计每个类别中的视频热度Top10</p>
<p>–统计每个类别中视频流量Top10</p>
<p>–统计上传视频最多的用户Top10以及他们上传的视频</p>
<p>–统计每个类别视频观看数Top10</p>
<h2 id="2、项目表字段"><a href="#2、项目表字段" class="headerlink" title="2、项目表字段"></a>2、项目表字段</h2><h3 id="1、数据结构"><a href="#1、数据结构" class="headerlink" title="1、数据结构"></a>1、数据结构</h3><p>1．视频表</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>备注</th>
<th>详细描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>video id</td>
<td>视频唯一id</td>
<td>11位字符串</td>
</tr>
<tr>
<td>uploader</td>
<td>视频上传者</td>
<td>上传视频的用户名String</td>
</tr>
<tr>
<td>age</td>
<td>视频年龄</td>
<td>视频在平台上的整数天</td>
</tr>
<tr>
<td>category</td>
<td>视频类别</td>
<td>上传视频指定的视频分类</td>
</tr>
<tr>
<td>length</td>
<td>视频长度</td>
<td>整形数字标识的视频长度</td>
</tr>
<tr>
<td>views</td>
<td>观看次数</td>
<td>视频被浏览的次数</td>
</tr>
<tr>
<td>rate</td>
<td>视频评分</td>
<td>满分5分</td>
</tr>
<tr>
<td>ratings</td>
<td>流量</td>
<td>视频的流量，整型数字</td>
</tr>
<tr>
<td>conments</td>
<td>评论数</td>
<td>一个视频的整数评论数</td>
</tr>
<tr>
<td>related   ids</td>
<td>相关视频id</td>
<td>相关视频的id，最多20个</td>
</tr>
</tbody>
</table>
<p>2．用户表</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>备注</th>
<th>字段类型</th>
</tr>
</thead>
<tbody>
<tr>
<td>uploader</td>
<td>上传者用户名</td>
<td>string</td>
</tr>
<tr>
<td>videos</td>
<td>上传视频数</td>
<td>int</td>
</tr>
<tr>
<td>friends</td>
<td>朋友数量</td>
<td>int</td>
</tr>
</tbody>
</table>
<h2 id="3、ETL原始数据清洗"><a href="#3、ETL原始数据清洗" class="headerlink" title="3、ETL原始数据清洗"></a>3、ETL原始数据清洗</h2><p>通过观察原始数据形式，可以发现，视频可以有多个所属分类，每个所属分类用&amp;符号分割，且分割的两边有空格字符，同时相关视频也是可以有多个元素，多个相关视频又用“\t”进行分割。为了分析数据时方便对存在多个子元素的数据进行操作，我们首先进行数据重组清洗操作。即：将所有的类别用“&amp;”分割，同时去掉两边空格，多个相关视频id也使用“&amp;”进行分割。</p>
<p>三件事情</p>
<ol>
<li><p>长度不够9的删掉</p>
</li>
<li><p>视频类别删掉空格</p>
</li>
<li><p>该相关视频的分割符</p>
</li>
</ol>
<p>创建maven工程，并导入jar包</p>
<figure class="highlight bnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">&lt;repositories&gt;</span></span><br><span class="line">        <span class="attribute">&lt;repository&gt;</span></span><br><span class="line">            <span class="attribute">&lt;id&gt;</span>cloudera<span class="attribute">&lt;/id&gt;</span></span><br><span class="line">            <span class="attribute">&lt;url&gt;</span>https://repository.cloudera.com/artifactory/cloudera-repos/<span class="attribute">&lt;/url&gt;</span></span><br><span class="line">        <span class="attribute">&lt;/repository&gt;</span></span><br><span class="line">    <span class="attribute">&lt;/repositories&gt;</span></span><br><span class="line">    <span class="attribute">&lt;dependencies&gt;</span></span><br><span class="line">        <span class="attribute">&lt;dependency&gt;</span></span><br><span class="line">            <span class="attribute">&lt;groupId&gt;</span>org.apache.hadoop<span class="attribute">&lt;/groupId&gt;</span></span><br><span class="line">            <span class="attribute">&lt;artifactId&gt;</span>hadoop-client<span class="attribute">&lt;/artifactId&gt;</span></span><br><span class="line">            <span class="attribute">&lt;version&gt;</span>2.6.0-mr1-cdh5.14.2<span class="attribute">&lt;/version&gt;</span></span><br><span class="line">        <span class="attribute">&lt;/dependency&gt;</span></span><br><span class="line">        <span class="attribute">&lt;dependency&gt;</span></span><br><span class="line">            <span class="attribute">&lt;groupId&gt;</span>org.apache.hadoop<span class="attribute">&lt;/groupId&gt;</span></span><br><span class="line">            <span class="attribute">&lt;artifactId&gt;</span>hadoop-common<span class="attribute">&lt;/artifactId&gt;</span></span><br><span class="line">            <span class="attribute">&lt;version&gt;</span>2.6.0-cdh5.14.2<span class="attribute">&lt;/version&gt;</span></span><br><span class="line">        <span class="attribute">&lt;/dependency&gt;</span></span><br><span class="line">        <span class="attribute">&lt;dependency&gt;</span></span><br><span class="line">            <span class="attribute">&lt;groupId&gt;</span>org.apache.hadoop<span class="attribute">&lt;/groupId&gt;</span></span><br><span class="line">            <span class="attribute">&lt;artifactId&gt;</span>hadoop-hdfs<span class="attribute">&lt;/artifactId&gt;</span></span><br><span class="line">            <span class="attribute">&lt;version&gt;</span>2.6.0-cdh5.14.2<span class="attribute">&lt;/version&gt;</span></span><br><span class="line">        <span class="attribute">&lt;/dependency&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="attribute">&lt;dependency&gt;</span></span><br><span class="line">            <span class="attribute">&lt;groupId&gt;</span>org.apache.hadoop<span class="attribute">&lt;/groupId&gt;</span></span><br><span class="line">            <span class="attribute">&lt;artifactId&gt;</span>hadoop-mapreduce-client-core<span class="attribute">&lt;/artifactId&gt;</span></span><br><span class="line">            <span class="attribute">&lt;version&gt;</span>2.6.0-cdh5.14.2<span class="attribute">&lt;/version&gt;</span></span><br><span class="line">        <span class="attribute">&lt;/dependency&gt;</span></span><br><span class="line">        <span class="attribute">&lt;!-- https://mvnrepository.com/artifact/junit/junit --&gt;</span></span><br><span class="line">        <span class="attribute">&lt;dependency&gt;</span></span><br><span class="line">            <span class="attribute">&lt;groupId&gt;</span>junit<span class="attribute">&lt;/groupId&gt;</span></span><br><span class="line">            <span class="attribute">&lt;artifactId&gt;</span>junit<span class="attribute">&lt;/artifactId&gt;</span></span><br><span class="line">            <span class="attribute">&lt;version&gt;</span>4.11<span class="attribute">&lt;/version&gt;</span></span><br><span class="line">            <span class="attribute">&lt;scope&gt;</span>test<span class="attribute">&lt;/scope&gt;</span></span><br><span class="line">        <span class="attribute">&lt;/dependency&gt;</span></span><br><span class="line">        <span class="attribute">&lt;dependency&gt;</span></span><br><span class="line">            <span class="attribute">&lt;groupId&gt;</span>org.testng<span class="attribute">&lt;/groupId&gt;</span></span><br><span class="line">            <span class="attribute">&lt;artifactId&gt;</span>testng<span class="attribute">&lt;/artifactId&gt;</span></span><br><span class="line">            <span class="attribute">&lt;version&gt;</span>RELEASE<span class="attribute">&lt;/version&gt;</span></span><br><span class="line">            <span class="attribute">&lt;scope&gt;</span>test<span class="attribute">&lt;/scope&gt;</span></span><br><span class="line">        <span class="attribute">&lt;/dependency&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="attribute">&lt;dependency&gt;</span></span><br><span class="line">            <span class="attribute">&lt;groupId&gt;</span>mysql<span class="attribute">&lt;/groupId&gt;</span></span><br><span class="line">            <span class="attribute">&lt;artifactId&gt;</span>mysql-connector-java<span class="attribute">&lt;/artifactId&gt;</span></span><br><span class="line">            <span class="attribute">&lt;version&gt;</span>5.1.38<span class="attribute">&lt;/version&gt;</span></span><br><span class="line">            <span class="attribute">&lt;scope&gt;</span>compile<span class="attribute">&lt;/scope&gt;</span></span><br><span class="line">        <span class="attribute">&lt;/dependency&gt;</span></span><br><span class="line">    <span class="attribute">&lt;/dependencies&gt;</span></span><br><span class="line">    <span class="attribute">&lt;build&gt;</span></span><br><span class="line">        <span class="attribute">&lt;plugins&gt;</span></span><br><span class="line">            <span class="attribute">&lt;plugin&gt;</span></span><br><span class="line">                <span class="attribute">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="attribute">&lt;/groupId&gt;</span></span><br><span class="line">                <span class="attribute">&lt;artifactId&gt;</span>maven-compiler-plugin<span class="attribute">&lt;/artifactId&gt;</span></span><br><span class="line">                <span class="attribute">&lt;version&gt;</span>3.0<span class="attribute">&lt;/version&gt;</span></span><br><span class="line">                <span class="attribute">&lt;configuration&gt;</span></span><br><span class="line">                    <span class="attribute">&lt;source&gt;</span>1.8<span class="attribute">&lt;/source&gt;</span></span><br><span class="line">                    <span class="attribute">&lt;target&gt;</span>1.8<span class="attribute">&lt;/target&gt;</span></span><br><span class="line">                    <span class="attribute">&lt;encoding&gt;</span>UTF-8<span class="attribute">&lt;/encoding&gt;</span></span><br><span class="line">                    <span class="attribute">&lt;!--    &lt;verbal&gt;</span>true<span class="attribute">&lt;/verbal&gt;</span>--&gt;</span><br><span class="line">                <span class="attribute">&lt;/configuration&gt;</span></span><br><span class="line">            <span class="attribute">&lt;/plugin&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="attribute">&lt;plugin&gt;</span></span><br><span class="line">                <span class="attribute">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="attribute">&lt;/groupId&gt;</span></span><br><span class="line">                <span class="attribute">&lt;artifactId&gt;</span>maven-shade-plugin<span class="attribute">&lt;/artifactId&gt;</span></span><br><span class="line">                <span class="attribute">&lt;version&gt;</span>2.4.3<span class="attribute">&lt;/version&gt;</span></span><br><span class="line">                <span class="attribute">&lt;executions&gt;</span></span><br><span class="line">                    <span class="attribute">&lt;execution&gt;</span></span><br><span class="line">                        <span class="attribute">&lt;phase&gt;</span>package<span class="attribute">&lt;/phase&gt;</span></span><br><span class="line">                        <span class="attribute">&lt;goals&gt;</span></span><br><span class="line">                            <span class="attribute">&lt;goal&gt;</span>shade<span class="attribute">&lt;/goal&gt;</span></span><br><span class="line">                        <span class="attribute">&lt;/goals&gt;</span></span><br><span class="line">                        <span class="attribute">&lt;configuration&gt;</span></span><br><span class="line">                            <span class="attribute">&lt;minimizeJar&gt;</span>true<span class="attribute">&lt;/minimizeJar&gt;</span></span><br><span class="line">                        <span class="attribute">&lt;/configuration&gt;</span></span><br><span class="line">                    <span class="attribute">&lt;/execution&gt;</span></span><br><span class="line">                <span class="attribute">&lt;/executions&gt;</span></span><br><span class="line">            <span class="attribute">&lt;/plugin&gt;</span></span><br><span class="line">            <span class="attribute">&lt;!--  &lt;plugin&gt;</span></span><br><span class="line">                  <span class="attribute">&lt;artifactId&gt;</span>maven-assembly-plugin <span class="attribute">&lt;/artifactId&gt;</span></span><br><span class="line">                  <span class="attribute">&lt;configuration&gt;</span></span><br><span class="line">                      <span class="attribute">&lt;descriptorRefs&gt;</span></span><br><span class="line">                          <span class="attribute">&lt;descriptorRef&gt;</span>jar-with-dependencies<span class="attribute">&lt;/descriptorRef&gt;</span></span><br><span class="line">                      <span class="attribute">&lt;/descriptorRefs&gt;</span></span><br><span class="line">                      <span class="attribute">&lt;archive&gt;</span></span><br><span class="line">                          <span class="attribute">&lt;manifest&gt;</span></span><br><span class="line">                              <span class="attribute">&lt;mainClass&gt;</span><span class="attribute">&lt;/mainClass&gt;</span></span><br><span class="line">                          <span class="attribute">&lt;/manifest&gt;</span></span><br><span class="line">                      <span class="attribute">&lt;/archive&gt;</span></span><br><span class="line">                  <span class="attribute">&lt;/configuration&gt;</span></span><br><span class="line">                  <span class="attribute">&lt;executions&gt;</span></span><br><span class="line">                      <span class="attribute">&lt;execution&gt;</span></span><br><span class="line">                          <span class="attribute">&lt;id&gt;</span>make-assembly<span class="attribute">&lt;/id&gt;</span></span><br><span class="line">                          <span class="attribute">&lt;phase&gt;</span>package<span class="attribute">&lt;/phase&gt;</span></span><br><span class="line">                          <span class="attribute">&lt;goals&gt;</span></span><br><span class="line">                              <span class="attribute">&lt;goal&gt;</span>single<span class="attribute">&lt;/goal&gt;</span></span><br><span class="line">                          <span class="attribute">&lt;/goals&gt;</span></span><br><span class="line">                      <span class="attribute">&lt;/execution&gt;</span></span><br><span class="line">                  <span class="attribute">&lt;/executions&gt;</span></span><br><span class="line">              <span class="attribute">&lt;/plugin&gt;</span>--&gt;</span><br><span class="line">        <span class="attribute">&lt;/plugins&gt;</span></span><br><span class="line">    <span class="attribute">&lt;/build&gt;</span></span><br></pre></td></tr></table></figure>
<p>1、代码开发：ETLUtil</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> class VideoUtil &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 对我们的数据进行清洗的工作，</span></span><br><span class="line"><span class="comment">     * 数据切割，如果长度小于9 直接丢掉</span></span><br><span class="line"><span class="comment">     * 视频类别中间空格 去掉</span></span><br><span class="line"><span class="comment">     * 关联视频，使用 &amp;  进行分割</span></span><br><span class="line"><span class="comment">     * @param line</span></span><br><span class="line"><span class="comment">     * @return</span></span><br><span class="line"><span class="comment">     * FM1KUDE3C3k  renetto	736	News &amp; Politics	1063	9062	4.57	525	488	LnMvSxl0o0A&amp;IKMtzNuKQso&amp;Bq8ubu7WHkY&amp;Su0VTfwia1w&amp;0SNRfquDfZs&amp;C72NVoPsRGw</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span>  <span class="keyword">static</span> <span class="keyword">String</span> washDatas(<span class="keyword">String</span> <span class="built_in">line</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">null</span> == <span class="built_in">line</span> || <span class="string">""</span>.equals(<span class="built_in">line</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//判断数据的长度，如果小于9，直接丢掉</span></span><br><span class="line">        <span class="keyword">String</span>[] <span class="built_in">split</span> = <span class="built_in">line</span>.<span class="built_in">split</span>(<span class="string">"\t"</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">split</span>.length &lt;<span class="number">9</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//将视频类别空格进行去掉</span></span><br><span class="line">        <span class="built_in">split</span>[<span class="number">3</span>] =  <span class="built_in">split</span>[<span class="number">3</span>].replace(<span class="string">" "</span>,<span class="string">""</span>);</span><br><span class="line">        StringBuilder builder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        <span class="keyword">for</span>(<span class="built_in">int</span> i =<span class="number">0</span>;i&lt;<span class="built_in">split</span>.length;i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(i &lt;<span class="number">9</span>)&#123;</span><br><span class="line">                <span class="comment">//这里面是前面八个字段</span></span><br><span class="line">                builder.<span class="built_in">append</span>(<span class="built_in">split</span>[i]).<span class="built_in">append</span>(<span class="string">"\t"</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span>(i &gt;=<span class="number">9</span>  &amp;&amp; i &lt; <span class="built_in">split</span>.length <span class="number">-1</span>)&#123;</span><br><span class="line">                builder.<span class="built_in">append</span>(<span class="built_in">split</span>[i]).<span class="built_in">append</span>(<span class="string">"&amp;"</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span>( i == <span class="built_in">split</span>.length <span class="number">-1</span>)&#123;</span><br><span class="line">                builder.<span class="built_in">append</span>(<span class="built_in">split</span>[i]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>  builder.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2、代码开发：ETLMapper</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.<span class="type">LongWritable</span>;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.<span class="type">NullWritable</span>;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.<span class="type">Text</span>;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.<span class="type">Mapper</span>;</span><br><span class="line"><span class="keyword">import</span> java.io.<span class="type">IOException</span>;</span><br><span class="line"></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">VideoMapper</span> <span class="keyword">extends</span> <span class="title">Mapper&lt;LongWritable</span>,<span class="title">Text</span>,<span class="title">Text</span>,<span class="title">NullWritable&gt;</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Text</span>  key2 ;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> void setup(<span class="type">Context</span> context) <span class="keyword">throws</span> <span class="type">IOException</span>, <span class="type">InterruptedException</span> &#123;</span><br><span class="line">        key2 = <span class="keyword">new</span> <span class="type">Text</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> void map(<span class="type">LongWritable</span> key, <span class="type">Text</span> value, <span class="type">Context</span> context) <span class="keyword">throws</span> <span class="type">IOException</span>, <span class="type">InterruptedException</span> &#123;</span><br><span class="line">        <span class="type">String</span> s = <span class="type">VideoUtils</span>.washDatas(value.toString());</span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">null</span> != s )&#123;</span><br><span class="line">            key2.set(s);</span><br><span class="line">            context.write(key2,<span class="type">NullWritable</span>.get());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3、代码开发：ETLRunner</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.hadoop.conf.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.conf.Configured;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.fs.Path;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.NullWritable;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.Text;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Job;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.input.TextInputFormat;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.output.TextOutputFormat;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.util.Tool;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.util.ToolRunner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VideoMain</span> <span class="keyword">extends</span> <span class="title">Configured</span> <span class="keyword">implements</span> <span class="title">Tool</span> &#123;</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> run(String[] args) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Job job = Job.getInstance(<span class="keyword">super</span>.getConf(), <span class="string">"washDatas"</span>);</span><br><span class="line">        job.setJarByClass(VideoMain.<span class="keyword">class</span>);</span><br><span class="line">        job.setInputFormatClass(TextInputFormat.<span class="keyword">class</span>);</span><br><span class="line">        TextInputFormat.addInputPath(job,<span class="keyword">new</span> Path(args[<span class="number">0</span>]));</span><br><span class="line"></span><br><span class="line">        job.setMapperClass(VideoMapper.<span class="keyword">class</span>);</span><br><span class="line">        job.setMapOutputKeyClass(Text.<span class="keyword">class</span>);</span><br><span class="line">        job.setMapOutputValueClass(NullWritable.<span class="keyword">class</span>);</span><br><span class="line">        job.setOutputFormatClass(TextOutputFormat.<span class="keyword">class</span>);</span><br><span class="line">        TextOutputFormat.setOutputPath(job,<span class="keyword">new</span> Path(args[<span class="number">1</span>]));</span><br><span class="line">        <span class="comment">//注意，我们这里没有自定义reducer，会使用默认的一个reducer类</span></span><br><span class="line">        job.setNumReduceTasks(<span class="number">7</span>);</span><br><span class="line">        <span class="keyword">boolean</span> b = job.waitForCompletion(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> b?0:<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> main(String[] args) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">int</span> run = ToolRunner.run(<span class="keyword">new</span> Configuration(), <span class="keyword">new</span> VideoMain(), args);</span><br><span class="line">        System.exit(run);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4、项目建表并加载数据"><a href="#4、项目建表并加载数据" class="headerlink" title="4、项目建表并加载数据"></a>4、项目建表并加载数据</h2><h3 id="1、创建表"><a href="#1、创建表" class="headerlink" title="1、创建表"></a>1、创建表</h3><p>创建表：youtubevideo_ori，youtubevideo_user_ori，</p>
<p>创建表：youtubevideo_orc，youtubevideo_user_orc</p>
<p>youtubevideo_ori：</p>
<p>开启分桶表功能</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> hive.enforce.bucketing=<span class="literal">true</span>;</span><br><span class="line"><span class="keyword">set</span> mapreduce.job.reduces=<span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">database</span> youtube;</span><br><span class="line"><span class="keyword">use</span> youtube;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> youtubevideo_ori(</span><br><span class="line">    videoId <span class="keyword">string</span>, </span><br><span class="line">    uploader <span class="keyword">string</span>, </span><br><span class="line">    age <span class="built_in">int</span>, </span><br><span class="line">    <span class="keyword">category</span> <span class="built_in">array</span>&lt;<span class="keyword">string</span>&gt;, </span><br><span class="line">    <span class="keyword">length</span> <span class="built_in">int</span>, </span><br><span class="line">    views <span class="built_in">int</span>, </span><br><span class="line">    rate <span class="built_in">float</span>, </span><br><span class="line">    ratings <span class="built_in">int</span>, </span><br><span class="line">    comments <span class="built_in">int</span>,</span><br><span class="line">    relatedId <span class="built_in">array</span>&lt;<span class="keyword">string</span>&gt;)</span><br><span class="line"><span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">delimited</span> </span><br><span class="line"><span class="keyword">fields</span> <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">"\t"</span></span><br><span class="line">collection items <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">"&amp;"</span></span><br><span class="line"><span class="keyword">stored</span> <span class="keyword">as</span> textfile;</span><br></pre></td></tr></table></figure>
<p>youtubevideo_user_ori：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> youtubevideo_user_ori(</span><br><span class="line">    uploader <span class="keyword">string</span>,</span><br><span class="line">    videos <span class="built_in">int</span>,</span><br><span class="line">    friends <span class="built_in">int</span>)</span><br><span class="line">clustered <span class="keyword">by</span> (uploader) <span class="keyword">into</span> <span class="number">24</span> buckets</span><br><span class="line"><span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">delimited</span> </span><br><span class="line"><span class="keyword">fields</span> <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">"\t"</span> </span><br><span class="line"><span class="keyword">stored</span> <span class="keyword">as</span> textfile;</span><br></pre></td></tr></table></figure>
<p>然后把原始数据插入到orc表中</p>
<p>youtubevideo_orc：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> youtubevideo_orc(</span><br><span class="line">    videoId <span class="keyword">string</span>, </span><br><span class="line">    uploader <span class="keyword">string</span>, </span><br><span class="line">    age <span class="built_in">int</span>, </span><br><span class="line">    <span class="keyword">category</span> <span class="built_in">array</span>&lt;<span class="keyword">string</span>&gt;, </span><br><span class="line">    <span class="keyword">length</span> <span class="built_in">int</span>, </span><br><span class="line">    views <span class="built_in">int</span>, </span><br><span class="line">    rate <span class="built_in">float</span>, </span><br><span class="line">    ratings <span class="built_in">int</span>, </span><br><span class="line">    comments <span class="built_in">int</span>,</span><br><span class="line">    relatedId <span class="built_in">array</span>&lt;<span class="keyword">string</span>&gt;)</span><br><span class="line">clustered <span class="keyword">by</span> (uploader) <span class="keyword">into</span> <span class="number">8</span> buckets </span><br><span class="line"><span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">delimited</span> <span class="keyword">fields</span> <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">"\t"</span> </span><br><span class="line">collection items <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">"&amp;"</span> </span><br><span class="line"><span class="keyword">stored</span> <span class="keyword">as</span> orc;</span><br></pre></td></tr></table></figure>
<p>youtubevideo_user_orc：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> youtubevideo_user_orc(</span><br><span class="line">    uploader <span class="keyword">string</span>,</span><br><span class="line">    videos <span class="built_in">int</span>,</span><br><span class="line">    friends <span class="built_in">int</span>)</span><br><span class="line">clustered <span class="keyword">by</span> (uploader) <span class="keyword">into</span> <span class="number">24</span> buckets </span><br><span class="line"><span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">delimited</span> </span><br><span class="line"><span class="keyword">fields</span> <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">"\t"</span> </span><br><span class="line"><span class="keyword">stored</span> <span class="keyword">as</span> orc;</span><br></pre></td></tr></table></figure>
<h3 id="2、导入ETL之后的数据"><a href="#2、导入ETL之后的数据" class="headerlink" title="2、导入ETL之后的数据"></a>2、导入ETL之后的数据</h3><p>youtubevideo_ori：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">load</span> <span class="keyword">data</span> inpath <span class="string">"/youtubevideo/output/video/2008/0222"</span> <span class="keyword">into</span> <span class="keyword">table</span> youtubevideo_ori;</span><br></pre></td></tr></table></figure>
<p>youtubevideo_user_ori：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">load</span> <span class="keyword">data</span> inpath <span class="string">"/youtubevideo/user/2008/0903"</span> <span class="keyword">into</span> <span class="keyword">table</span> youtubevideo_user_ori;</span><br></pre></td></tr></table></figure>
<h3 id="3、向ORC表插入数据"><a href="#3、向ORC表插入数据" class="headerlink" title="3、向ORC表插入数据"></a>3、向ORC表插入数据</h3><p>youtubevideo_orc：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> youtubevideo_orc <span class="keyword">select</span> * <span class="keyword">from</span> youtubevideo_ori;</span><br></pre></td></tr></table></figure>
<p>youtubevideo_user_orc：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">table</span> youtubevideo_user_orc <span class="keyword">select</span> * <span class="keyword">from</span> youtubevideo_user_ori;</span><br></pre></td></tr></table></figure>
<h2 id="5、业务分析"><a href="#5、业务分析" class="headerlink" title="5、业务分析"></a>5、业务分析</h2><h3 id="1、统计视频观看数Top10"><a href="#1、统计视频观看数Top10" class="headerlink" title="1、统计视频观看数Top10"></a>1、统计视频观看数Top10</h3><p>思路：使用order by按照views字段做一个全局排序即可，同时我们设置只显示前10条。</p>
<p>最终代码：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    videoId, </span><br><span class="line">    uploader, </span><br><span class="line">    age, </span><br><span class="line">    <span class="keyword">category</span>, </span><br><span class="line">    <span class="keyword">length</span>, </span><br><span class="line">    views, </span><br><span class="line">    rate, </span><br><span class="line">    ratings, </span><br><span class="line">    comments </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    youtubevideo_orc </span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> </span><br><span class="line">    views </span><br><span class="line"><span class="keyword">desc</span> <span class="keyword">limit</span> </span><br><span class="line">    <span class="number">10</span>;</span><br></pre></td></tr></table></figure>
<h3 id="2、统计视频类别热度Top10"><a href="#2、统计视频类别热度Top10" class="headerlink" title="2、统计视频类别热度Top10"></a>2、统计视频类别热度Top10</h3><p>思路：</p>
<p>1) 即统计每个类别有多少个视频，显示出包含视频最多的前10个类别。</p>
<p>2) 我们需要按照类别group by聚合，然后count组内的videoId个数即可。</p>
<p>3) 因为当前表结构为：一个视频对应一个或多个类别。所以如果要group by类别，需要先将类别进行列转行(展开)，然后再进行count即可。</p>
<p>4) 最后按照热度排序，显示前10条。</p>
<p>最终代码：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    category_name <span class="keyword">as</span> <span class="keyword">category</span>, </span><br><span class="line">    <span class="keyword">count</span>(t1.videoId) <span class="keyword">as</span> hot </span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">    <span class="keyword">select</span> </span><br><span class="line">        videoId,</span><br><span class="line">        category_name </span><br><span class="line">    <span class="keyword">from</span> </span><br><span class="line">        youtubevideo_orc lateral <span class="keyword">view</span> explode(<span class="keyword">category</span>) t_catetory <span class="keyword">as</span> category_name) t1 </span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">    t1.category_name </span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> </span><br><span class="line">    hot </span><br><span class="line"><span class="keyword">desc</span> <span class="keyword">limit</span> </span><br><span class="line">    <span class="number">10</span>;</span><br></pre></td></tr></table></figure>
<h3 id="3、统计出视频观看数最高的20个视频的所属类别以及类别包含Top20视频的个数"><a href="#3、统计出视频观看数最高的20个视频的所属类别以及类别包含Top20视频的个数" class="headerlink" title="3、统计出视频观看数最高的20个视频的所属类别以及类别包含Top20视频的个数"></a>3、统计出视频观看数最高的20个视频的所属类别以及类别包含Top20视频的个数</h3><p>思路：</p>
<p>1) 先找到观看数最高的20个视频所属条目的所有信息，降序排列</p>
<p>2) 把这20条信息中的category分裂出来(列转行)</p>
<p>3) 最后查询视频分类名称和该分类下有多少个Top20的视频</p>
<p>最终代码：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    category_name <span class="keyword">as</span> <span class="keyword">category</span>, </span><br><span class="line">    <span class="keyword">count</span>(t2.videoId) <span class="keyword">as</span> hot_with_views </span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">    <span class="keyword">select</span> </span><br><span class="line">        videoId, </span><br><span class="line">        category_name </span><br><span class="line">    <span class="keyword">from</span> (</span><br><span class="line">        <span class="keyword">select</span> </span><br><span class="line">            * </span><br><span class="line">        <span class="keyword">from</span> </span><br><span class="line">            youtubevideo_orc </span><br><span class="line">        <span class="keyword">order</span> <span class="keyword">by</span> </span><br><span class="line">            views </span><br><span class="line">        <span class="keyword">desc</span> <span class="keyword">limit</span> </span><br><span class="line">            <span class="number">20</span>) t1 lateral <span class="keyword">view</span> explode(<span class="keyword">category</span>) t_catetory <span class="keyword">as</span> category_name) t2 </span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">    category_name </span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> </span><br><span class="line">    hot_with_views </span><br><span class="line"><span class="keyword">desc</span>;</span><br></pre></td></tr></table></figure>
<h3 id="4、-统计视频观看数Top50所关联视频的所属类别Rank"><a href="#4、-统计视频观看数Top50所关联视频的所属类别Rank" class="headerlink" title="4、 统计视频观看数Top50所关联视频的所属类别Rank"></a>4、 统计视频观看数Top50所关联视频的所属类别Rank</h3><p>思路：</p>
<p>1)       查询出观看数最多的前50个视频的所有信息(当然包含了每个视频对应的关联视频)，记为临时表t1</p>
<p>t1：观看数前50的视频</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    * </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    youtubevideo_orc </span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> </span><br><span class="line">    views </span><br><span class="line"><span class="keyword">desc</span> <span class="keyword">limit</span> </span><br><span class="line">    <span class="number">50</span>;</span><br></pre></td></tr></table></figure>
<p>2)       将找到的50条视频信息的相关视频relatedId列转行，记为临时表t2</p>
<p>t2：将相关视频的id进行列转行操作</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    explode(relatedId) <span class="keyword">as</span> videoId </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">	t1;</span><br></pre></td></tr></table></figure>
<p>3)       将相关视频的id和youtubevideo_orc表进行inner join操作</p>
<p>t5：得到两列数据，一列是category，一列是之前查询出来的相关视频id</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">select</span> </span><br><span class="line">    <span class="keyword">distinct</span>(t2.videoId), </span><br><span class="line">    t3.category </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    t2</span><br><span class="line"><span class="keyword">inner</span> <span class="keyword">join</span> </span><br><span class="line">    youtubevideo_orc t3 <span class="keyword">on</span> t2.videoId = t3.videoId) t4 lateral <span class="keyword">view</span> explode(<span class="keyword">category</span>) t_catetory <span class="keyword">as</span> category_name;</span><br></pre></td></tr></table></figure>
<p>4) 按照视频类别进行分组，统计每组视频个数，然后排行</p>
<p>最终代码：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    category_name <span class="keyword">as</span> <span class="keyword">category</span>, </span><br><span class="line">    <span class="keyword">count</span>(t5.videoId) <span class="keyword">as</span> hot </span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">    <span class="keyword">select</span> </span><br><span class="line">        videoId, </span><br><span class="line">        category_name </span><br><span class="line">    <span class="keyword">from</span> (</span><br><span class="line">        <span class="keyword">select</span> </span><br><span class="line">            <span class="keyword">distinct</span>(t2.videoId), </span><br><span class="line">            t3.category </span><br><span class="line">        <span class="keyword">from</span> (</span><br><span class="line">            <span class="keyword">select</span> </span><br><span class="line">                explode(relatedId) <span class="keyword">as</span> videoId </span><br><span class="line">            <span class="keyword">from</span> (</span><br><span class="line">                <span class="keyword">select</span> </span><br><span class="line">                    * </span><br><span class="line">                <span class="keyword">from</span> </span><br><span class="line">                    youtubevideo_orc </span><br><span class="line">                <span class="keyword">order</span> <span class="keyword">by</span> </span><br><span class="line">                    views </span><br><span class="line">                <span class="keyword">desc</span> <span class="keyword">limit</span> </span><br><span class="line">                    <span class="number">50</span>) t1) t2 </span><br><span class="line">        <span class="keyword">inner</span> <span class="keyword">join</span> </span><br><span class="line">            youtubevideo_orc t3 <span class="keyword">on</span> t2.videoId = t3.videoId) t4 lateral <span class="keyword">view</span> explode(<span class="keyword">category</span>) t_catetory <span class="keyword">as</span> category_name) t5</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">    category_name </span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> </span><br><span class="line">    hot </span><br><span class="line"><span class="keyword">desc</span>;</span><br></pre></td></tr></table></figure>
<h3 id="5、统计每个类别中的视频热度Top10，以Music为例"><a href="#5、统计每个类别中的视频热度Top10，以Music为例" class="headerlink" title="5、统计每个类别中的视频热度Top10，以Music为例"></a>5、统计每个类别中的视频热度Top10，以Music为例</h3><p>思路：</p>
<p>1) 要想统计Music类别中的视频热度Top10，需要先找到Music类别，那么就需要将category展开，所以可以创建一张表用于存放categoryId展开的数据。</p>
<p>2) 向category展开的表中插入数据。</p>
<p>3) 统计对应类别（Music）中的视频热度。</p>
<p>最终代码：</p>
<p>创建表类别表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> youtubevideo_category(</span><br><span class="line">    videoId <span class="keyword">string</span>, </span><br><span class="line">    uploader <span class="keyword">string</span>, </span><br><span class="line">    age <span class="built_in">int</span>, </span><br><span class="line">    categoryId <span class="keyword">string</span>, </span><br><span class="line">    <span class="keyword">length</span> <span class="built_in">int</span>, </span><br><span class="line">    views <span class="built_in">int</span>, </span><br><span class="line">    rate <span class="built_in">float</span>, </span><br><span class="line">    ratings <span class="built_in">int</span>, </span><br><span class="line">    comments <span class="built_in">int</span>, </span><br><span class="line">    relatedId <span class="built_in">array</span>&lt;<span class="keyword">string</span>&gt;)</span><br><span class="line"><span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">delimited</span> </span><br><span class="line"><span class="keyword">fields</span> <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">"\t"</span> </span><br><span class="line">collection items <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">"&amp;"</span> </span><br><span class="line"><span class="keyword">stored</span> <span class="keyword">as</span> orc;</span><br></pre></td></tr></table></figure>
<p>向类别表中插入数据：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">table</span> youtubevideo_category  </span><br><span class="line">    <span class="keyword">select</span> </span><br><span class="line">        videoId,</span><br><span class="line">        uploader,</span><br><span class="line">        age,</span><br><span class="line">        categoryId,</span><br><span class="line">        <span class="keyword">length</span>,</span><br><span class="line">        views,</span><br><span class="line">        rate,</span><br><span class="line">        ratings,</span><br><span class="line">        comments,</span><br><span class="line">        relatedId </span><br><span class="line">    <span class="keyword">from</span> </span><br><span class="line">        youtubevideo_orc lateral <span class="keyword">view</span> explode(<span class="keyword">category</span>) catetory <span class="keyword">as</span> categoryId;</span><br></pre></td></tr></table></figure>
<p>统计Music类别的Top10（也可以统计其他）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    videoId, </span><br><span class="line">    views</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    youtubevideo_category </span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">    categoryId = <span class="string">"Music"</span> </span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> </span><br><span class="line">    views </span><br><span class="line"><span class="keyword">desc</span> <span class="keyword">limit</span></span><br><span class="line">    <span class="number">10</span>;</span><br></pre></td></tr></table></figure>
<h3 id="6、-统计每个类别中视频流量Top10，以Music为例"><a href="#6、-统计每个类别中视频流量Top10，以Music为例" class="headerlink" title="6、 统计每个类别中视频流量Top10，以Music为例"></a>6、 统计每个类别中视频流量Top10，以Music为例</h3><p>思路：</p>
<p>1) 创建视频类别展开表（categoryId列转行后的表）</p>
<p>2) 按照ratings排序即可</p>
<p>最终代码：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> videoid,views,ratings </span><br><span class="line"><span class="keyword">from</span> youtubevideo_category </span><br><span class="line"><span class="keyword">where</span> categoryid = <span class="string">"Music"</span> <span class="keyword">order</span> <span class="keyword">by</span> ratings <span class="keyword">desc</span> <span class="keyword">limit</span> <span class="number">10</span>;</span><br></pre></td></tr></table></figure>
<h3 id="7、-统计上传视频最多的用户Top10以及他们上传的观看次数在前20的视频"><a href="#7、-统计上传视频最多的用户Top10以及他们上传的观看次数在前20的视频" class="headerlink" title="7、 统计上传视频最多的用户Top10以及他们上传的观看次数在前20的视频"></a>7、 统计上传视频最多的用户Top10以及他们上传的观看次数在前20的视频</h3><p>思路：</p>
<p>1) 先找到上传视频最多的10个用户的用户信息</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    * </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    youtubevideo_user_orc </span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> </span><br><span class="line">    videos </span><br><span class="line"><span class="keyword">desc</span> <span class="keyword">limit</span> </span><br><span class="line">    <span class="number">10</span>;</span><br></pre></td></tr></table></figure>
<p>2) 通过uploader字段与youtubevideo_orc表进行join，得到的信息按照views观看次数进行排序即可。</p>
<p>最终代码：</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">select </span><br><span class="line">    <span class="built_in">t2</span>.videoId, </span><br><span class="line">    <span class="built_in">t2</span>.views,</span><br><span class="line">    <span class="built_in">t2</span>.ratings,</span><br><span class="line">    <span class="built_in">t1</span>.videos,</span><br><span class="line">    <span class="built_in">t1</span>.friends </span><br><span class="line">from (</span><br><span class="line">    select </span><br><span class="line">        * </span><br><span class="line">    from </span><br><span class="line">        youtubevideo_user_orc </span><br><span class="line">    <span class="keyword">order </span><span class="keyword">by </span></span><br><span class="line">        videos desc </span><br><span class="line">    limit </span><br><span class="line">        <span class="number">10</span>) <span class="built_in">t1</span> </span><br><span class="line"><span class="keyword">join </span></span><br><span class="line">    youtubevideo_orc <span class="built_in">t2</span></span><br><span class="line">on </span><br><span class="line">    <span class="built_in">t1</span>.uploader = <span class="built_in">t2</span>.uploader </span><br><span class="line"><span class="keyword">order </span><span class="keyword">by </span></span><br><span class="line">    views desc </span><br><span class="line">limit </span><br><span class="line">    <span class="number">20</span><span class="comment">;</span></span><br></pre></td></tr></table></figure>
<h3 id="8、统计每个类别视频观看数Top10"><a href="#8、统计每个类别视频观看数Top10" class="headerlink" title="8、统计每个类别视频观看数Top10"></a>8、统计每个类别视频观看数Top10</h3><p>思路：</p>
<p>1) 先得到categoryId展开的表数据</p>
<p>2) 子查询按照categoryId进行分区，然后分区内排序，并生成递增数字，该递增数字这一列起名为rank列</p>
<p>3) 通过子查询产生的临时表，查询rank值小于等于10的数据行即可。</p>
<p>最终代码：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    t1.* </span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">    <span class="keyword">select</span> </span><br><span class="line">        videoId,</span><br><span class="line">        categoryId,</span><br><span class="line">        views,</span><br><span class="line">        row_number() <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> categoryId <span class="keyword">order</span> <span class="keyword">by</span> views <span class="keyword">desc</span>) <span class="keyword">rank</span> <span class="keyword">from</span> youtubevideo_category) t1 </span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">    <span class="keyword">rank</span> &lt;= <span class="number">10</span>;</span><br></pre></td></tr></table></figure>

        
        <br />
        <div id="comment-container">
        </div>
        <div id="disqus_thread"></div>

        <div id="lv-container">
        </div>

    </div>
</div>

    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        

        

    </ul>
    
    <p>
        <span>/</span>
        
        <span><a href="https://blog.sev7e0.site/">大数据施工现场</a></span>
        <span>/</span>
        
    </p>
    
    <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>
        Created By <a href="https://hexo.io/">Hexo</a>  Theme <a href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a></p>
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "search.json"
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="/js/index.js"></script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




</html>
