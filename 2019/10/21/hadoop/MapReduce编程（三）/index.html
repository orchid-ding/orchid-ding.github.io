<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="天行健、君子以自强不息；地势坤，君子以厚德载物。">
    <meta name="keyword"  content="兰草">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
        MapReduce编程（三） - Kaffir Lily的博客 | Kaffir Lily&#39;s Blog
        
    </title>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/aircloud.css">
    <link rel="stylesheet" href="/css/gitment.css">
    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_pl6z7sid89qkt9.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
</head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i> 君子谦谦，温和有礼，有才而不骄，得志而不傲，居于谷而不卑。 </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar ">
            <img src="/img/avatar.jpg" />
        </div>
        <div class="name">
            <i>kfly</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li >
                <a href="/">
                    <i class="icon-font icon-shouye1"></i>
                    <span>主页</span>
                </a>
            </li>
            <li >
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>标签</span>
                </a>
            </li>
            <li >
                <a href="/archive">
                    <i class="iconfont icon-guidang2"></i>
                    <span>存档</span>
                </a>
            </li>
            <li >
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>关于</span>
                </a>
            </li>
            
            <li>
                <a id="search">
                    <i class="iconfont icon-sousuo1"></i>
                    <span>搜索</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#MapReduce编程模型"><span class="toc-text">MapReduce编程模型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-自定义OutputFormat"><span class="toc-text">1. 自定义OutputFormat</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-需求"><span class="toc-text">1.1 需求</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-逻辑分析"><span class="toc-text">1.2 逻辑分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-实现要点"><span class="toc-text">1.3 实现要点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-4-MR代码"><span class="toc-text">1.4 MR代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-5-总结"><span class="toc-text">1.5 总结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-二次排序"><span class="toc-text">2. 二次排序</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-需求"><span class="toc-text">2.1 需求</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-逻辑分析"><span class="toc-text">2.2 逻辑分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-MR代码"><span class="toc-text">2.3 MR代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-总结"><span class="toc-text">2.4 总结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-自定义分组求topN"><span class="toc-text">3. 自定义分组求topN</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-需求"><span class="toc-text">3.1 需求</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-逻辑分析"><span class="toc-text">3.2 逻辑分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-MR代码"><span class="toc-text">3.3 MR代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4-总结"><span class="toc-text">3.4 总结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-MapReduce数据倾斜-20分钟"><span class="toc-text">4. MapReduce数据倾斜(20分钟)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-如何诊断是否存在数据倾斜（10分钟）"><span class="toc-text">4.1 如何诊断是否存在数据倾斜（10分钟）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-减缓数据倾斜"><span class="toc-text">4.2 减缓数据倾斜</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-MR调优"><span class="toc-text">5. MR调优</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-抽样、范围分区"><span class="toc-text">6. 抽样、范围分区</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#6-1-数据"><span class="toc-text">6.1 数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-需求"><span class="toc-text">6.2 需求</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-3-实现方案"><span class="toc-text">6.3 实现方案</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-4-MR代码"><span class="toc-text">6.4 MR代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-5-总结"><span class="toc-text">6.5 总结</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#注意"><span class="toc-text">注意</span></a></li></ol></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input"/>
            <span id="begin-search">搜索</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>

        <div class="index-about-mobile">
            <i> 君子谦谦，温和有礼，有才而不骄，得志而不傲，居于谷而不卑。 </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        MapReduce编程（三）
    </div>

    <div class="post-meta">
        <span class="attr">发布于：<span>2019-10-21 23:06:43</span></span>
        
        <span class="attr">标签：/
        
        <a class="tag" href="/tags/#hadoop" title="hadoop">hadoop</a>
        <span>/</span>
        
        <a class="tag" href="/tags/#MapReduce" title="MapReduce">MapReduce</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">访问：<span id="busuanzi_value_page_pv"></span>
</span>
</span>
    </div>
    <div class="post-content ">
        <h1 id="MapReduce编程模型"><a href="#MapReduce编程模型" class="headerlink" title="MapReduce编程模型"></a>MapReduce编程模型</h1><h3 id="1-自定义OutputFormat"><a href="#1-自定义OutputFormat" class="headerlink" title="1. 自定义OutputFormat"></a>1. 自定义OutputFormat</h3><h4 id="1-1-需求"><a href="#1-1-需求" class="headerlink" title="1.1 需求"></a>1.1 需求</h4><ul>
<li><p>现在有一些订单的评论数据，要将订单的好评与其它级别的评论（中评、差评）进行区分开来，将最终的数据分开到不同的文件夹下面去</p>
</li>
<li><p>数据第九个字段表示评分等级：0 好评，1 中评，2 差评</p>
<p><img src="assets/Image201909111129.png" alt=""></p>
</li>
</ul>
<h4 id="1-2-逻辑分析"><a href="#1-2-逻辑分析" class="headerlink" title="1.2 逻辑分析"></a>1.2 逻辑分析</h4><ul>
<li>程序的关键点是在一个mapreduce程序中，根据数据的不同(好评的评级不同)，输出两类结果到不同<strong>目录</strong></li>
<li>这类灵活的输出，需求通过自定义OutputFormat来实现</li>
</ul>
<h4 id="1-3-实现要点"><a href="#1-3-实现要点" class="headerlink" title="1.3 实现要点"></a>1.3 实现要点</h4><ul>
<li>在mapreduce中访问外部资源</li>
<li>自定义OutputFormat类，覆写getRecordWriter()方法</li>
<li>自定义RecordWriter类，覆写具体输出数据的方法write()</li>
</ul>
<h4 id="1-4-MR代码"><a href="#1-4-MR代码" class="headerlink" title="1.4 MR代码"></a>1.4 MR代码</h4><ul>
<li>自定义OutputFormat</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kaikeba.hadoop.outputformat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.fs.FSDataOutputStream;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.fs.FileSystem;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.fs.Path;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.NullWritable;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.Text;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.RecordWriter;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.TaskAttemptContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.output.FileOutputFormat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 本例使用框架默认的Reducer，它将Mapper输入的kv对，原样输出；所以reduce输出的kv类型分别是Text, NullWritable</span></span><br><span class="line"><span class="comment"> * 自定义OutputFormat的类，泛型表示reduce输出的键值对类型；要保持一致;</span></span><br><span class="line"><span class="comment"> * map--(kv)--&gt;reduce--(kv)--&gt;OutputFormat</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyOutPutFormat</span> <span class="keyword">extends</span> <span class="title">FileOutputFormat</span>&lt;<span class="title">Text</span>, <span class="title">NullWritable</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 两个输出文件;</span></span><br><span class="line"><span class="comment">     * good用于保存好评文件；其它评级保存到bad中</span></span><br><span class="line"><span class="comment">     * 根据实际情况修改path;node01及端口号8020</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String bad = <span class="string">"hdfs://node01:8020/outputformat/bad/r.txt"</span>;</span><br><span class="line">    String good = <span class="string">"hdfs://node01:8020/outputformat/good/r.txt"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> context</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> InterruptedException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RecordWriter&lt;Text, NullWritable&gt; <span class="title">getRecordWriter</span><span class="params">(TaskAttemptContext context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">//获得文件系统对象</span></span><br><span class="line">        FileSystem fs = FileSystem.get(context.getConfiguration());</span><br><span class="line">        <span class="comment">//两个输出文件路径</span></span><br><span class="line">        Path badPath = <span class="keyword">new</span> Path(bad);</span><br><span class="line">        Path goodPath = <span class="keyword">new</span> Path(good);</span><br><span class="line">        FSDataOutputStream badOut = fs.create(badPath);</span><br><span class="line">        FSDataOutputStream goodOut = fs.create(goodPath);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MyRecordWriter(badOut,goodOut);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 泛型表示reduce输出的键值对类型；要保持一致</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyRecordWriter</span> <span class="keyword">extends</span> <span class="title">RecordWriter</span>&lt;<span class="title">Text</span>, <span class="title">NullWritable</span>&gt;</span>&#123;</span><br><span class="line"></span><br><span class="line">        FSDataOutputStream badOut = <span class="keyword">null</span>;</span><br><span class="line">        FSDataOutputStream goodOut = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MyRecordWriter</span><span class="params">(FSDataOutputStream badOut, FSDataOutputStream goodOut)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.badOut = badOut;</span><br><span class="line">            <span class="keyword">this</span>.goodOut = goodOut;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 自定义输出kv对逻辑</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> key</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> value</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@throws</span> InterruptedException</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(Text key, NullWritable value)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (key.toString().split(<span class="string">"\t"</span>)[<span class="number">9</span>].equals(<span class="string">"0"</span>))&#123;<span class="comment">//好评</span></span><br><span class="line">                goodOut.write(key.toString().getBytes());</span><br><span class="line">                goodOut.write(<span class="string">"\r\n"</span>.getBytes());</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;<span class="comment">//其它评级</span></span><br><span class="line">                badOut.write(key.toString().getBytes());</span><br><span class="line">                badOut.write(<span class="string">"\r\n"</span>.getBytes());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 关闭流</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> context</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@throws</span> InterruptedException</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">(TaskAttemptContext context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(goodOut !=<span class="keyword">null</span>)&#123;</span><br><span class="line">                goodOut.close();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(badOut !=<span class="keyword">null</span>)&#123;</span><br><span class="line">                badOut.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>main方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kaikeba.hadoop.outputformat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.conf.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.conf.Configured;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.fs.Path;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.LongWritable;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.NullWritable;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.Text;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Job;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Mapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.input.TextInputFormat;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.util.Tool;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.util.ToolRunner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyOwnOutputFormatMain</span> <span class="keyword">extends</span> <span class="title">Configured</span> <span class="keyword">implements</span> <span class="title">Tool</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">run</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Configuration conf = <span class="keyword">super</span>.getConf();</span><br><span class="line">        Job job = Job.getInstance(conf, MyOwnOutputFormatMain.class.getSimpleName());</span><br><span class="line">        job.setJarByClass(MyOwnOutputFormatMain.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//默认项，可以省略或者写出也可以</span></span><br><span class="line">        <span class="comment">//job.setInputFormatClass(TextInputFormat.class);</span></span><br><span class="line">        <span class="comment">//设置输入文件</span></span><br><span class="line">        TextInputFormat.addInputPath(job, <span class="keyword">new</span> Path(args[<span class="number">0</span>]));</span><br><span class="line">        job.setMapperClass(MyMapper.class);</span><br><span class="line">        <span class="comment">//job.setMapOutputKeyClass(Text.class);</span></span><br><span class="line">        <span class="comment">//job.setMapOutputValueClass(NullWritable.class);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置自定义的输出类</span></span><br><span class="line">        job.setOutputFormatClass(MyOutPutFormat.class);</span><br><span class="line">        <span class="comment">//设置一个输出目录，这个目录会输出一个success的成功标志的文件</span></span><br><span class="line">        MyOutPutFormat.setOutputPath(job, <span class="keyword">new</span> Path(args[<span class="number">1</span>]));</span><br><span class="line">        job.setOutputKeyClass(Text.class);</span><br><span class="line">        job.setOutputValueClass(NullWritable.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//默认项，即默认有一个reduce任务，所以可以省略</span></span><br><span class="line"><span class="comment">//        job.setNumReduceTasks(1);</span></span><br><span class="line"><span class="comment">//        //Reducer将输入的键值对原样输出</span></span><br><span class="line"><span class="comment">//        job.setReducerClass(Reducer.class);</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> b = job.waitForCompletion(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> b ? <span class="number">0</span>: <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Mapper输出的key、value类型</span></span><br><span class="line"><span class="comment">     * 文件每行的内容作为输出的key，对应Text类型</span></span><br><span class="line"><span class="comment">     * 输出的value为null，对应NullWritable</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyMapper</span> <span class="keyword">extends</span> <span class="title">Mapper</span>&lt;<span class="title">LongWritable</span>, <span class="title">Text</span>, <span class="title">Text</span>, <span class="title">NullWritable</span>&gt; </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(LongWritable key, Text value, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">            <span class="comment">//把当前行内容作为key输出；value为null</span></span><br><span class="line">            context.write(value, NullWritable.get());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> args /ordercomment.csv /ofo</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Configuration configuration = <span class="keyword">new</span> Configuration();</span><br><span class="line">        ToolRunner.run(configuration, <span class="keyword">new</span> MyOwnOutputFormatMain(), args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="1-5-总结"><a href="#1-5-总结" class="headerlink" title="1.5 总结"></a>1.5 总结</h4><ul>
<li>自定义outputformat<ul>
<li>泛型与reduce输出的键值对类型保持一致</li>
<li>覆写getRecordWriter()方法</li>
</ul>
</li>
<li><p>自定义RecordWriter</p>
<ul>
<li>泛型与reduce输出的键值对类型保持一致</li>
<li>覆写具体输出数据的方法write()、close()</li>
</ul>
</li>
<li><p>main方法</p>
<ul>
<li>job.setOutputFormatClass使用自定义在输出类</li>
</ul>
</li>
</ul>
<h3 id="2-二次排序"><a href="#2-二次排序" class="headerlink" title="2. 二次排序"></a>2. 二次排序</h3><h4 id="2-1-需求"><a href="#2-1-需求" class="headerlink" title="2.1 需求"></a>2.1 需求</h4><ul>
<li><p>数据：有一个简单的关于员工工资的记录文件salary.txt</p>
<ul>
<li><p>每条记录如下，有3个字段，分别表示name、age、salary</p>
</li>
<li><p>nancy    22    8000</p>
<p><img src="assets/Image201910181039.png" alt=""></p>
</li>
</ul>
</li>
<li><p>使用MR处理记录，实现结果中</p>
<ul>
<li>按照工资从高到低的降序排序</li>
<li>若工资相同，则按年龄升序排序</li>
</ul>
</li>
</ul>
<h4 id="2-2-逻辑分析"><a href="#2-2-逻辑分析" class="headerlink" title="2.2 逻辑分析"></a>2.2 逻辑分析</h4><ul>
<li><p>利用MR中key具有可比较的特点</p>
</li>
<li><p>MapReduce中，根据key进行分区、排序、分组</p>
</li>
<li><p>有些MR的输出的key可以直接使用hadoop框架的可序列化可比较类型表示，如Text、IntWritable等等，而这些类型本身是可比较的；如IntWritable默认升序排序</p>
<p><img src="assets/Image201909111209.png" alt=""></p>
</li>
<li><p>但有时，使用MR编程，输出的key，若使用hadoop自带的key类型无法满足需求</p>
<ul>
<li>此时，需要自定义的key类型（包含的是非单一信息，如此例包含工资、年龄）；</li>
<li>并且也得是<strong><font color="red">可序列化、可比较的</font></strong></li>
</ul>
</li>
<li><p>需要自定义key，定义排序规则</p>
<ul>
<li>实现：按照人的salary降序排序，若相同，则再按age升序排序；若salary、age相同，则放入同一组</li>
</ul>
</li>
</ul>
<h4 id="2-3-MR代码"><a href="#2-3-MR代码" class="headerlink" title="2.3 MR代码"></a>2.3 MR代码</h4><ul>
<li>详见工程代码</li>
<li>自定义key类型Person类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kaikeba.hadoop.secondarysort;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.WritableComparable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.DataInput;</span><br><span class="line"><span class="keyword">import</span> java.io.DataOutput;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">//根据输入文件格式，定义JavaBean，作为MR时，Map的输出key类型；要求此类可序列化、可比较</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> <span class="keyword">implements</span> <span class="title">WritableComparable</span>&lt;<span class="title">Person</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> salary;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Person</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Person</span><span class="params">(String name, <span class="keyword">int</span> age, <span class="keyword">int</span> salary)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//super();</span></span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">        <span class="keyword">this</span>.salary = salary;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(<span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getSalary</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> salary;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSalary</span><span class="params">(<span class="keyword">int</span> salary)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.salary = salary;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.salary + <span class="string">"  "</span> + <span class="keyword">this</span>.age + <span class="string">"    "</span> + <span class="keyword">this</span>.name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//两个Person对象的比较规则：①先比较salary，高的排序在前；②若相同，age小的在前</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(Person other)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> compareResult= <span class="keyword">this</span>.salary - other.salary;</span><br><span class="line">        <span class="keyword">if</span>(compareResult != <span class="number">0</span>) &#123;<span class="comment">//若两个人工资不同</span></span><br><span class="line">            <span class="comment">//工资降序排序；即工资高的排在前边</span></span><br><span class="line">            <span class="keyword">return</span> -compareResult;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;<span class="comment">//若工资相同</span></span><br><span class="line">            <span class="comment">//年龄升序排序；即年龄小的排在前边</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.age - other.age;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//序列化，将NewKey转化成使用流传送的二进制</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(DataOutput dataOutput)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">//注意：①使用正确的write方法；②记住此时的序列化的顺序，name、age、salary</span></span><br><span class="line">        dataOutput.writeUTF(name);</span><br><span class="line">        dataOutput.writeInt(age);</span><br><span class="line">        dataOutput.writeInt(salary);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//使用in读字段的顺序，要与write方法中写的顺序保持一致：name、age、salary</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">readFields</span><span class="params">(DataInput dataInput)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">//read string</span></span><br><span class="line">        <span class="comment">//注意：①使用正确的read方法；②读取顺序与write()中序列化的顺序保持一致</span></span><br><span class="line">        <span class="keyword">this</span>.name = dataInput.readUTF();</span><br><span class="line">        <span class="keyword">this</span>.age = dataInput.readInt();</span><br><span class="line">        <span class="keyword">this</span>.salary = dataInput.readInt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>main类、mapper、reducer</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kaikeba.hadoop.secondarysort;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.conf.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.fs.FileSystem;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.fs.Path;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.LongWritable;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.NullWritable;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.Text;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Job;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Mapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Reducer;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.input.FileInputFormat;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.output.FileOutputFormat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.URI;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecondarySort</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> args /salary.txt /secondarysort</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		Configuration configuration = <span class="keyword">new</span> Configuration();</span><br><span class="line">		<span class="comment">//configuration.set("mapreduce.job.jar","/home/bruce/project/kkbhdp01/target/com.kaikeba.hadoop-1.0-SNAPSHOT.jar");</span></span><br><span class="line">		Job job = Job.getInstance(configuration, SecondarySort.class.getSimpleName());</span><br><span class="line"></span><br><span class="line">		FileSystem fileSystem = FileSystem.get(URI.create(args[<span class="number">1</span>]), configuration);</span><br><span class="line">		<span class="comment">//生产中慎用</span></span><br><span class="line">		<span class="keyword">if</span> (fileSystem.exists(<span class="keyword">new</span> Path(args[<span class="number">1</span>]))) &#123;</span><br><span class="line">			fileSystem.delete(<span class="keyword">new</span> Path(args[<span class="number">1</span>]), <span class="keyword">true</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		FileInputFormat.setInputPaths(job, <span class="keyword">new</span> Path(args[<span class="number">0</span>]));</span><br><span class="line">		job.setMapperClass(MyMap.class);</span><br><span class="line">		<span class="comment">//由于mapper与reducer输出的kv类型分别相同，所以，下两行可以省略</span></span><br><span class="line"><span class="comment">//		job.setMapOutputKeyClass(Person.class);</span></span><br><span class="line"><span class="comment">//		job.setMapOutputValueClass(NullWritable.class);</span></span><br><span class="line">		</span><br><span class="line">		<span class="comment">//设置reduce的个数;默认为1</span></span><br><span class="line">		<span class="comment">//job.setNumReduceTasks(1);</span></span><br><span class="line"></span><br><span class="line">		job.setReducerClass(MyReduce.class);</span><br><span class="line">		job.setOutputKeyClass(Person.class);</span><br><span class="line">		job.setOutputValueClass(NullWritable.class);</span><br><span class="line">		FileOutputFormat.setOutputPath(job, <span class="keyword">new</span> Path(args[<span class="number">1</span>]));</span><br><span class="line"></span><br><span class="line">		job.waitForCompletion(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//MyMap的输出key用自定义的Person类型；输出的value为null</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyMap</span> <span class="keyword">extends</span> <span class="title">Mapper</span>&lt;<span class="title">LongWritable</span>, <span class="title">Text</span>, <span class="title">Person</span>, <span class="title">NullWritable</span>&gt; </span>&#123;</span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(LongWritable key, Text value, Context context)</span></span></span><br><span class="line"><span class="function">				<span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line"></span><br><span class="line">			String[] fields = value.toString().split(<span class="string">"\t"</span>);</span><br><span class="line">			String name = fields[<span class="number">0</span>];</span><br><span class="line">			<span class="keyword">int</span> age = Integer.parseInt(fields[<span class="number">1</span>]);</span><br><span class="line">			<span class="keyword">int</span> salary = Integer.parseInt(fields[<span class="number">2</span>]);</span><br><span class="line">			<span class="comment">//在自定义类中进行比较</span></span><br><span class="line">			Person person = <span class="keyword">new</span> Person(name, age, salary);</span><br><span class="line">			<span class="comment">//person对象作为输出的key</span></span><br><span class="line">			context.write(person, NullWritable.get());</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyReduce</span> <span class="keyword">extends</span> <span class="title">Reducer</span>&lt;<span class="title">Person</span>, <span class="title">NullWritable</span>, <span class="title">Person</span>, <span class="title">NullWritable</span>&gt; </span>&#123;</span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">reduce</span><span class="params">(Person key, Iterable&lt;NullWritable&gt; values, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">			<span class="comment">//输入的kv对，原样输出</span></span><br><span class="line">			context.write(key, NullWritable.get());</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-4-总结"><a href="#2-4-总结" class="headerlink" title="2.4 总结"></a>2.4 总结</h4><ul>
<li>如果MR时，key的排序规则比较复杂，比如需要根据字段1排序，若字段1相同，则需要根据字段2排序…，此时，可以使用自定义key实现</li>
<li>将自定义的key作为MR中，map输出的key的类型（reduce输入的类型）</li>
<li>自定义的key<ul>
<li>实现WritableComparable接口</li>
<li>实现compareTo比较方法</li>
<li>实现write序列化方法</li>
<li>实现readFields反序列化方法</li>
</ul>
</li>
</ul>
<h3 id="3-自定义分组求topN"><a href="#3-自定义分组求topN" class="headerlink" title="3. 自定义分组求topN"></a>3. 自定义分组求topN</h3><h4 id="3-1-需求"><a href="#3-1-需求" class="headerlink" title="3.1 需求"></a>3.1 需求</h4><ul>
<li><p>现有一个淘宝用户订单历史记录文件；每条记录有6个字段，分别表示</p>
<ul>
<li>userid、datetime、title商品标题、unitPrice商品单价、purchaseNum购买量、productId商品ID</li>
</ul>
<p><img src="assets/Image201909111241.png" alt=""></p>
</li>
<li><p>现使用MR编程，求出每个用户、每个月消费金额最多的两笔订单，花了多少钱</p>
<ul>
<li>所以得相同用户、同一个年月的数据，分到同一组</li>
</ul>
</li>
</ul>
<h4 id="3-2-逻辑分析"><a href="#3-2-逻辑分析" class="headerlink" title="3.2 逻辑分析"></a>3.2 逻辑分析</h4><ul>
<li>根据文件格式，自定义JavaBean类OrderBean<ul>
<li>实现WritableComparable接口</li>
<li>包含6个字段分别对应文件中的6个字段</li>
<li>重点实现compareTo方法<ul>
<li>先比较userid是否相等；若不相等，则userid升序排序</li>
<li>若相等，比较两个Bean的日期是否相等；若不相等，则日期升序排序</li>
<li>若相等，再比较总开销，降序排序</li>
</ul>
</li>
<li>实现序列化方法write()</li>
<li>实现反序列化方法readFields()</li>
</ul>
</li>
<li>自定义分区类<ul>
<li>继承Partitioner类</li>
<li>getPartiton()实现，userid相同的，处于同一个分区</li>
</ul>
</li>
<li>自定义Mapper类<ul>
<li>输出key是当前记录对应的Bean对象</li>
<li>输出的value对应当前下单的总开销</li>
</ul>
</li>
<li>自定义分组类<ul>
<li>决定userid相同、日期（年月）相同的记录，分到同一组中，调用一次reduce()</li>
</ul>
</li>
<li>自定义Reduce类<ul>
<li>reduce()中求出当前一组数据中，开销头两笔的信息</li>
</ul>
</li>
<li>main方法<ul>
<li>job.setMapperClass</li>
<li>job.setPartitionerClass</li>
<li>job.setReducerClass</li>
<li>job.setGroupingComparatorClass</li>
</ul>
</li>
</ul>
<h4 id="3-3-MR代码"><a href="#3-3-MR代码" class="headerlink" title="3.3 MR代码"></a>3.3 MR代码</h4><blockquote>
<p>详细代码见代码工程</p>
</blockquote>
<ul>
<li>OrderBean</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kaikeba.hadoop.grouping;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.WritableComparable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.DataInput;</span><br><span class="line"><span class="keyword">import</span> java.io.DataOutput;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">//实现WritableComparable接口</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderBean</span> <span class="keyword">implements</span> <span class="title">WritableComparable</span>&lt;<span class="title">OrderBean</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//用户ID</span></span><br><span class="line">    <span class="keyword">private</span> String userid;</span><br><span class="line">    <span class="comment">//年月</span></span><br><span class="line">    <span class="comment">//year+month -&gt; 201408</span></span><br><span class="line">    <span class="keyword">private</span> String datetime;</span><br><span class="line">    <span class="comment">//标题</span></span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line">    <span class="comment">//单价</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">double</span> unitPrice;</span><br><span class="line">    <span class="comment">//购买量</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> purchaseNum;</span><br><span class="line">    <span class="comment">//商品ID</span></span><br><span class="line">    <span class="keyword">private</span> String produceId;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OrderBean</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OrderBean</span><span class="params">(String userid, String datetime, String title, <span class="keyword">double</span> unitPrice, <span class="keyword">int</span> purchaseNum, String produceId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        <span class="keyword">this</span>.userid = userid;</span><br><span class="line">        <span class="keyword">this</span>.datetime = datetime;</span><br><span class="line">        <span class="keyword">this</span>.title = title;</span><br><span class="line">        <span class="keyword">this</span>.unitPrice = unitPrice;</span><br><span class="line">        <span class="keyword">this</span>.purchaseNum = purchaseNum;</span><br><span class="line">        <span class="keyword">this</span>.produceId = produceId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//key的比较规则</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(OrderBean other)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//OrderBean作为MR中的key；如果对象中的userid相同，即ret1为0；就表示两个对象是同一个用户</span></span><br><span class="line">        <span class="keyword">int</span> ret1 = <span class="keyword">this</span>.userid.compareTo(other.userid);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ret1 == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//如果userid相同，比较年月</span></span><br><span class="line">            String thisYearMonth = <span class="keyword">this</span>.getDatetime();</span><br><span class="line">            String otherYearMonth = other.getDatetime();</span><br><span class="line">            <span class="keyword">int</span> ret2 = thisYearMonth.compareTo(otherYearMonth);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(ret2 == <span class="number">0</span>) &#123;<span class="comment">//若datetime相同</span></span><br><span class="line">                <span class="comment">//如果userid、年月都相同，比较单笔订单的总开销</span></span><br><span class="line">                Double thisTotalPrice = <span class="keyword">this</span>.getPurchaseNum()*<span class="keyword">this</span>.getUnitPrice();</span><br><span class="line">                Double oTotalPrice = other.getPurchaseNum()*other.getUnitPrice();</span><br><span class="line">                <span class="comment">//总花销降序排序；即总花销高的排在前边</span></span><br><span class="line">                <span class="keyword">return</span> -thisTotalPrice.compareTo(oTotalPrice);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//若datatime不同，按照datetime升序排序</span></span><br><span class="line">                <span class="keyword">return</span> ret2;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//按照userid升序排序</span></span><br><span class="line">            <span class="keyword">return</span> ret1;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 序列化</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dataOutput</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(DataOutput dataOutput)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        dataOutput.writeUTF(userid);</span><br><span class="line">        dataOutput.writeUTF(datetime);</span><br><span class="line">        dataOutput.writeUTF(title);</span><br><span class="line">        dataOutput.writeDouble(unitPrice);</span><br><span class="line">        dataOutput.writeInt(purchaseNum);</span><br><span class="line">        dataOutput.writeUTF(produceId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 反序列化</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dataInput</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">readFields</span><span class="params">(DataInput dataInput)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userid = dataInput.readUTF();</span><br><span class="line">        <span class="keyword">this</span>.datetime = dataInput.readUTF();</span><br><span class="line">        <span class="keyword">this</span>.title = dataInput.readUTF();</span><br><span class="line">        <span class="keyword">this</span>.unitPrice = dataInput.readDouble();</span><br><span class="line">        <span class="keyword">this</span>.purchaseNum = dataInput.readInt();</span><br><span class="line">        <span class="keyword">this</span>.produceId = dataInput.readUTF();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 使用默认分区器，那么userid相同的，落入同一分区；</span></span><br><span class="line"><span class="comment">     * 另外一个方案：此处不覆写hashCode方法，而是自定义分区器，getPartition方法中，对OrderBean的userid求hashCode值%reduce任务数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="comment">//    @Override</span></span><br><span class="line"><span class="comment">//    public int hashCode() &#123;</span></span><br><span class="line"><span class="comment">//        return this.userid.hashCode();</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"OrderBean&#123;"</span> +</span><br><span class="line">                <span class="string">"userid='"</span> + userid + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", datetime='"</span> + datetime + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", title='"</span> + title + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", unitPrice="</span> + unitPrice +</span><br><span class="line">                <span class="string">", purchaseNum="</span> + purchaseNum +</span><br><span class="line">                <span class="string">", produceId='"</span> + produceId + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">'&#125;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUserid</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userid;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserid</span><span class="params">(String userid)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userid = userid;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDatetime</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> datetime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDatetime</span><span class="params">(String datetime)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.datetime = datetime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getTitle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> title;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTitle</span><span class="params">(String title)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.title = title;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">getUnitPrice</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> unitPrice;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUnitPrice</span><span class="params">(<span class="keyword">double</span> unitPrice)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.unitPrice = unitPrice;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPurchaseNum</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> purchaseNum;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPurchaseNum</span><span class="params">(<span class="keyword">int</span> purchaseNum)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.purchaseNum = purchaseNum;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getProduceId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> produceId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setProduceId</span><span class="params">(String produceId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.produceId = produceId;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>MyPartitioner</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kaikeba.hadoop.grouping;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.DoubleWritable;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Partitioner;</span><br><span class="line"></span><br><span class="line"><span class="comment">//mapper的输出key类型是自定义的key类型OrderBean；输出value类型是单笔订单的总开销double -&gt; DoubleWritable</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyPartitioner</span> <span class="keyword">extends</span> <span class="title">Partitioner</span>&lt;<span class="title">OrderBean</span>, <span class="title">DoubleWritable</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPartition</span><span class="params">(OrderBean orderBean, DoubleWritable doubleWritable, <span class="keyword">int</span> numReduceTasks)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//userid相同的，落入同一分区</span></span><br><span class="line">        <span class="keyword">return</span> (orderBean.getUserid().hashCode() &amp; Integer.MAX_VALUE) % numReduceTasks;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>MyMapper</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kaikeba.hadoop.grouping;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.DoubleWritable;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.LongWritable;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.Text;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 输出kv，分别是OrderBean、用户每次下单的总开销</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyMapper</span> <span class="keyword">extends</span> <span class="title">Mapper</span>&lt;<span class="title">LongWritable</span>, <span class="title">Text</span>, <span class="title">OrderBean</span>, <span class="title">DoubleWritable</span>&gt; </span>&#123;</span><br><span class="line">    DoubleWritable valueOut = <span class="keyword">new</span> DoubleWritable();</span><br><span class="line">    DateUtils dateUtils = <span class="keyword">new</span> DateUtils();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(LongWritable key, Text value, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">//13764633023     2014-12-01 02:20:42.000 全视目Allseelook 原宿风暴显色美瞳彩色隐形艺术眼镜1片 拍2包邮    33.6    2       18067781305</span></span><br><span class="line">        String record = value.toString();</span><br><span class="line">        String[] fields = record.split(<span class="string">"\t"</span>);</span><br><span class="line">        <span class="keyword">if</span>(fields.length == <span class="number">6</span>) &#123;</span><br><span class="line">            String userid = fields[<span class="number">0</span>];</span><br><span class="line">            String datetime = fields[<span class="number">1</span>];</span><br><span class="line">            String yearMonth = dateUtils.getYearMonthString(datetime);</span><br><span class="line">            String title = fields[<span class="number">2</span>];</span><br><span class="line">            <span class="keyword">double</span> unitPrice = Double.parseDouble(fields[<span class="number">3</span>]);</span><br><span class="line">            <span class="keyword">int</span> purchaseNum = Integer.parseInt(fields[<span class="number">4</span>]);</span><br><span class="line">            String produceId = fields[<span class="number">5</span>];</span><br><span class="line"></span><br><span class="line">            <span class="comment">//生成OrderBean对象</span></span><br><span class="line">            OrderBean orderBean = <span class="keyword">new</span> OrderBean(userid, yearMonth, title, unitPrice, purchaseNum, produceId);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//此订单的总开销</span></span><br><span class="line">            <span class="keyword">double</span> totalPrice = unitPrice * purchaseNum;</span><br><span class="line">            valueOut.set(totalPrice);</span><br><span class="line"></span><br><span class="line">            context.write(orderBean, valueOut);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>MyReducer</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kaikeba.hadoop.grouping;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.DoubleWritable;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.NullWritable;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.Text;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Reducer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">//输出的key为userid拼接上年月的字符串，对应Text；输出的value对应单笔订单的金额</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyReducer</span> <span class="keyword">extends</span> <span class="title">Reducer</span>&lt;<span class="title">OrderBean</span>, <span class="title">DoubleWritable</span>, <span class="title">Text</span>, <span class="title">DoubleWritable</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ①由于自定义分组逻辑，相同用户、相同年月的订单是一组，调用一次reduce()；</span></span><br><span class="line"><span class="comment">     * ②由于自定义的key类OrderBean中，比较规则compareTo规定，相同用户、相同年月的订单，按总金额降序排序</span></span><br><span class="line"><span class="comment">     * 所以取出头两笔，就实现需求</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> values</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> context</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> InterruptedException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">reduce</span><span class="params">(OrderBean key, Iterable&lt;DoubleWritable&gt; values, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">//求每个用户、每个月、消费金额最多的两笔多少钱</span></span><br><span class="line">        <span class="keyword">int</span> num = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(DoubleWritable value: values) &#123;</span><br><span class="line">            <span class="keyword">if</span>(num &lt; <span class="number">2</span>) &#123;</span><br><span class="line">                String keyOut = key.getUserid() + <span class="string">"  "</span> + key.getDatetime();</span><br><span class="line">                context.write(<span class="keyword">new</span> Text(keyOut), value);</span><br><span class="line">                num++;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>MyGroup</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kaikeba.hadoop.grouping;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.WritableComparable;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.WritableComparator;</span><br><span class="line"></span><br><span class="line"><span class="comment">//自定义分组类：reduce端调用reduce()前，对数据做分组；每组数据调用一次reduce()</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyGroup</span> <span class="keyword">extends</span> <span class="title">WritableComparator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyGroup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//第一个参数表示key class</span></span><br><span class="line">        <span class="keyword">super</span>(OrderBean.class, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  	<span class="comment">// 注意： 分组实现的方法是这个</span></span><br><span class="line">  	<span class="comment">// compare（Object a,Object b） 这个方法不可以</span></span><br><span class="line">    <span class="comment">//分组逻辑</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(WritableComparable a, WritableComparable b)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//userid相同，且同一月的分成一组</span></span><br><span class="line">        OrderBean aOrderBean = (OrderBean)a;</span><br><span class="line">        OrderBean bOrderBean = (OrderBean)b;</span><br><span class="line"></span><br><span class="line">        String aUserId = aOrderBean.getUserid();</span><br><span class="line">        String bUserId = bOrderBean.getUserid();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//userid、年、月相同的，作为一组</span></span><br><span class="line">        <span class="keyword">int</span> ret1 = aUserId.compareTo(bUserId);</span><br><span class="line">        <span class="keyword">if</span>(ret1 == <span class="number">0</span>) &#123;<span class="comment">//同一用户</span></span><br><span class="line">            <span class="comment">//年月也相同返回0，在同一组；</span></span><br><span class="line">            <span class="keyword">return</span> aOrderBean.getDatetime().compareTo(bOrderBean.getDatetime());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> ret1;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>CustomGroupingMain</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kaikeba.hadoop.grouping;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.kaikeba.hadoop.wordcount.WordCountMain;</span><br><span class="line"><span class="keyword">import</span> com.kaikeba.hadoop.wordcount.WordCountMap;</span><br><span class="line"><span class="keyword">import</span> com.kaikeba.hadoop.wordcount.WordCountReduce;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.conf.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.conf.Configured;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.fs.Path;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.DoubleWritable;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.IntWritable;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.Text;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Job;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.input.FileInputFormat;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.output.FileOutputFormat;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.util.Tool;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.util.ToolRunner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomGroupingMain</span> <span class="keyword">extends</span> <span class="title">Configured</span> <span class="keyword">implements</span> <span class="title">Tool</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">///tmall-201412-test.csv /cgo</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> exitCode = ToolRunner.run(<span class="keyword">new</span> CustomGroupingMain(), args);</span><br><span class="line">        System.exit(exitCode);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">run</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//判断以下，输入参数是否是两个，分别表示输入路径、输出路径</span></span><br><span class="line">        <span class="keyword">if</span> (args.length != <span class="number">2</span> || args == <span class="keyword">null</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">"please input Path!"</span>);</span><br><span class="line">            System.exit(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Configuration configuration = <span class="keyword">new</span> Configuration();</span><br><span class="line">        <span class="comment">//告诉程序，要运行的jar包在哪</span></span><br><span class="line">        <span class="comment">//configuration.set("mapreduce.job.jar","/home/hadoop/IdeaProjects/Hadoop/target/com.kaikeba.hadoop-1.0-SNAPSHOT.jar");</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//调用getInstance方法，生成job实例</span></span><br><span class="line">        Job job = Job.getInstance(configuration, CustomGroupingMain.class.getSimpleName());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置jar包，参数是包含main方法的类</span></span><br><span class="line">        job.setJarByClass(CustomGroupingMain.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//通过job设置输入/输出格式</span></span><br><span class="line">        <span class="comment">//MR的默认输入格式是TextInputFormat，所以下两行可以注释掉</span></span><br><span class="line"><span class="comment">//        job.setInputFormatClass(TextInputFormat.class);</span></span><br><span class="line"><span class="comment">//        job.setOutputFormatClass(TextOutputFormat.class);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置输入/输出路径</span></span><br><span class="line">        FileInputFormat.setInputPaths(job, <span class="keyword">new</span> Path(args[<span class="number">0</span>]));</span><br><span class="line">        FileOutputFormat.setOutputPath(job, <span class="keyword">new</span> Path(args[<span class="number">1</span>]));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置处理Map阶段的自定义的类</span></span><br><span class="line">        job.setMapperClass(MyMapper.class);</span><br><span class="line">        <span class="comment">//设置map combine类，减少网路传出量</span></span><br><span class="line">        <span class="comment">//job.setCombinerClass(MyReducer.class);</span></span><br><span class="line">        job.setPartitionerClass(MyPartitioner.class);</span><br><span class="line">        <span class="comment">//设置处理Reduce阶段的自定义的类</span></span><br><span class="line">        job.setReducerClass(MyReducer.class);</span><br><span class="line">        job.setGroupingComparatorClass(MyGroup.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果map、reduce的输出的kv对类型一致，直接设置reduce的输出的kv对就行；如果不一样，需要分别设置map, reduce的输出的kv类型</span></span><br><span class="line">        <span class="comment">//注意：此处设置的map输出的key/value类型，一定要与自定义map类输出的kv对类型一致；否则程序运行报错</span></span><br><span class="line">        job.setMapOutputKeyClass(OrderBean.class);</span><br><span class="line">        job.setMapOutputValueClass(DoubleWritable.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置reduce task最终输出key/value的类型</span></span><br><span class="line">        <span class="comment">//注意：此处设置的reduce输出的key/value类型，一定要与自定义reduce类输出的kv对类型一致；否则程序运行报错</span></span><br><span class="line">        job.setOutputKeyClass(Text.class);</span><br><span class="line">        job.setOutputValueClass(DoubleWritable.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 提交作业</span></span><br><span class="line">        <span class="keyword">return</span> job.waitForCompletion(<span class="keyword">true</span>) ? <span class="number">0</span> : <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>DateUtils</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kaikeba.hadoop.grouping;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.time.format.DateTimeFormatter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DateUtils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//test1</span></span><br><span class="line"><span class="comment">//        String str1 = "13764633024  2014-10-01 02:20:42.000";</span></span><br><span class="line"><span class="comment">//        String str2 = "13764633023  2014-11-01 02:20:42.000";</span></span><br><span class="line"><span class="comment">//        System.out.println(str1.compareTo(str2));</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//test2</span></span><br><span class="line"><span class="comment">//        String datetime = "2014-12-01 02:20:42.000";</span></span><br><span class="line"><span class="comment">//        LocalDateTime localDateTime = parseDateTime(datetime);</span></span><br><span class="line"><span class="comment">//        int year = localDateTime.getYear();</span></span><br><span class="line"><span class="comment">//        int month = localDateTime.getMonthValue();</span></span><br><span class="line"><span class="comment">//        int day = localDateTime.getDayOfMonth();</span></span><br><span class="line"><span class="comment">//        System.out.println("year-&gt; " + year + "; month -&gt; " + month + "; day -&gt; " + day);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//test3</span></span><br><span class="line"><span class="comment">//        String datetime = "2014-12-01 02:20:42.000";</span></span><br><span class="line"><span class="comment">//        System.out.println(getYearMonthString(datetime));</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LocalDateTime <span class="title">parseDateTime</span><span class="params">(String dateTime)</span> </span>&#123;</span><br><span class="line">        DateTimeFormatter formatter = DateTimeFormatter.ofPattern(<span class="string">"yyyy-MM-dd HH:mm:ss.SSS"</span>);</span><br><span class="line">        LocalDateTime localDateTime = LocalDateTime.parse(dateTime, formatter);</span><br><span class="line">        <span class="keyword">return</span> localDateTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//日期格式转换工具类：将2014-12-14 20:42:14.000转换成201412</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getYearMonthString</span><span class="params">(String dateTime)</span> </span>&#123;</span><br><span class="line">        DateTimeFormatter formatter = DateTimeFormatter.ofPattern(<span class="string">"yyyy-MM-dd HH:mm:ss.SSS"</span>);</span><br><span class="line">        LocalDateTime localDateTime = LocalDateTime.parse(dateTime, formatter);</span><br><span class="line">        <span class="keyword">int</span> year = localDateTime.getYear();</span><br><span class="line">        <span class="keyword">int</span> month = localDateTime.getMonthValue();</span><br><span class="line">        <span class="keyword">return</span> year + <span class="string">""</span> + month;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-4-总结"><a href="#3-4-总结" class="headerlink" title="3.4 总结"></a>3.4 总结</h4><ul>
<li>要实现自定义分组逻辑<ul>
<li>一般会自定义JavaBean，作为map输出的key<ul>
<li>实现其中的compareTo方法，设置key的比较逻辑</li>
<li>实现序列化方法write()</li>
<li>实现反序列化方法readFields()</li>
</ul>
</li>
<li>自定义mapper类、reducer类</li>
<li>自定义partition类，getPartition方法，决定哪些key落入哪些分区</li>
<li>自定义group分组类，决定reduce阶段，哪些kv对，落入同一组，调用一次reduce()</li>
<li>写main方法，设置自定义的类<ul>
<li>job.setMapperClass</li>
<li>job.setPartitionerClass</li>
<li>job.setReducerClass</li>
<li>job.setGroupingComparatorClass</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="4-MapReduce数据倾斜-20分钟"><a href="#4-MapReduce数据倾斜-20分钟" class="headerlink" title="4. MapReduce数据倾斜(20分钟)"></a>4. MapReduce数据倾斜(20分钟)</h3><ul>
<li>什么是数据倾斜？<ul>
<li>数据中不可避免地会出现离群值（outlier），并导致数据倾斜。这些离群值会显著地拖慢MapReduce的执行。</li>
</ul>
</li>
<li><p>常见的数据倾斜有以下几类：</p>
<ul>
<li>数据频率倾斜——某一个区域的数据量要远远大于其他区域。比如某一个key对应的键值对远远大于其他键的键值对。</li>
<li>数据大小倾斜——部分记录的大小远远大于平均值。</li>
</ul>
</li>
<li><p>在map端和reduce端都有可能发生数据倾斜</p>
<ul>
<li>在map端的数据倾斜可以考虑使用combine</li>
<li>在reduce端的数据倾斜常常来源于MapReduce的默认分区器</li>
</ul>
</li>
<li><p>数据倾斜会导致map和reduce的任务执行时间大为延长，也会让需要缓存数据集的操作消耗更多的内存资源</p>
</li>
</ul>
<h4 id="4-1-如何诊断是否存在数据倾斜（10分钟）"><a href="#4-1-如何诊断是否存在数据倾斜（10分钟）" class="headerlink" title="4.1 如何诊断是否存在数据倾斜（10分钟）"></a>4.1 如何诊断是否存在数据倾斜（10分钟）</h4><ol start="2">
<li>如何诊断哪些键存在数据倾斜？<ul>
<li>发现倾斜数据之后，有必要诊断造成数据倾斜的那些键。有一个简便方法就是在代码里实现追踪每个键的<strong>最大值</strong>。</li>
<li>为了减少追踪量，可以设置数据量阀值，只追踪那些数据量大于阀值的键，并输出到日志中。实现代码如下</li>
<li>运行作业后就可以从日志中判断发生倾斜的键以及倾斜程度；跟踪倾斜数据是了解数据的重要一步，也是设计MapReduce作业的重要基础</li>
</ul>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kaikeba.hadoop.dataskew;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.IntWritable;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.Text;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Reducer;</span><br><span class="line"><span class="keyword">import</span> org.apache.log4j.Logger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WordCountReduce</span> <span class="keyword">extends</span> <span class="title">Reducer</span>&lt;<span class="title">Text</span>, <span class="title">IntWritable</span>, <span class="title">Text</span>, <span class="title">IntWritable</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> maxValueThreshold;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//日志类</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = Logger.getLogger(WordCountReduce.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setup</span><span class="params">(Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//一个键达到多少后，会做数据倾斜记录</span></span><br><span class="line">        maxValueThreshold = <span class="number">10000</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">            (hello, 1)</span></span><br><span class="line"><span class="comment">            (hello, 1)</span></span><br><span class="line"><span class="comment">            (hello, 1)</span></span><br><span class="line"><span class="comment">            ...</span></span><br><span class="line"><span class="comment">            (spark, 1)</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">            key: hello</span></span><br><span class="line"><span class="comment">            value: List(1, 1, 1)</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reduce</span><span class="params">(Text key, Iterable&lt;IntWritable&gt; values,</span></span></span><br><span class="line"><span class="function"><span class="params">                          Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">//用于记录键出现的次数</span></span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (IntWritable count : values) &#123;</span><br><span class="line">            sum += count.get();</span><br><span class="line">            i++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果当前键超过10000个，则打印日志</span></span><br><span class="line">        <span class="keyword">if</span>(i &gt; maxValueThreshold) &#123;</span><br><span class="line">            LOGGER.info(<span class="string">"Received "</span> + i + <span class="string">" values for key "</span> + key);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        context.write(key, <span class="keyword">new</span> IntWritable(sum));<span class="comment">// 输出最终结果</span></span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4-2-减缓数据倾斜"><a href="#4-2-减缓数据倾斜" class="headerlink" title="4.2 减缓数据倾斜"></a>4.2 减缓数据倾斜</h4><ul>
<li><p>Reduce数据倾斜一般是指map的输出数据中存在数据频率倾斜的状况，即部分输出键的数据量远远大于其它的输出键</p>
</li>
<li><p>如何减小reduce端数据倾斜的性能损失？常用方式有：</p>
<ul>
<li><p>一、自定义分区</p>
<ul>
<li><p>基于输出键的背景知识进行自定义分区。</p>
</li>
<li><p>例如，如果map输出键的单词来源于一本书。其中大部分必然是省略词（stopword）。那么就可以将自定义分区将这部分省略词发送给固定的一部分reduce实例。而将其他的都发送给剩余的reduce实例。</p>
</li>
</ul>
</li>
<li><p>二、Combine</p>
<ul>
<li>使用Combine可以大量地减小数据频率倾斜和数据大小倾斜。</li>
<li>combine的目的就是聚合并精简数据。</li>
</ul>
</li>
<li><p>三、抽样和范围分区</p>
<ul>
<li><p>Hadoop默认的分区器是HashPartitioner，基于map输出键的哈希值分区。这仅在数据分布比较均匀时比较好。<strong>在有数据倾斜时就很有问题</strong>。</p>
</li>
<li><p>使用分区器需要首先了解数据的特性。<strong>TotalOrderPartitioner</strong>中，可以通过对原始数据进行抽样得到的结果集来<strong>预设分区边界值</strong>。</p>
</li>
<li>TotalOrderPartitioner中的范围分区器可以通过预设的分区边界值进行分区。因此它也可以很好地用在矫正数据中的部分键的数据倾斜问题。</li>
</ul>
</li>
<li><p>四、数据大小倾斜的自定义策略</p>
<ul>
<li><p>在map端或reduce端的数据大小倾斜都会对缓存造成较大的影响，乃至导致OutOfMemoryError异常。处理这种情况并不容易。可以参考以下方法。</p>
</li>
<li><p>设置mapreduce.input.linerecordreader.line.maxlength来限制RecordReader读取的最大长度。</p>
</li>
<li>RecordReader在TextInputFormat和KeyValueTextInputFormat类中使用。默认长度没有上限。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="5-MR调优"><a href="#5-MR调优" class="headerlink" title="5. MR调优"></a>5. MR调优</h3><ul>
<li>见后续文章</li>
</ul>
<h3 id="6-抽样、范围分区"><a href="#6-抽样、范围分区" class="headerlink" title="6. 抽样、范围分区"></a>6. 抽样、范围分区</h3><h4 id="6-1-数据"><a href="#6-1-数据" class="headerlink" title="6.1 数据"></a>6.1 数据</h4><ul>
<li><p>数据：气象站气象数据，来源美国国家气候数据中心（NCDC）（1900-2000年数据，每年一个文件）</p>
<ul>
<li>气候数据record的格式如下</li>
</ul>
</li>
</ul>
<p><img src="assets/Image201907151554.png" alt=""></p>
<h4 id="6-2-需求"><a href="#6-2-需求" class="headerlink" title="6.2 需求"></a>6.2 需求</h4><ul>
<li>对气象数据，按照气温进行排序（气温符合正太分布）</li>
</ul>
<h4 id="6-3-实现方案"><a href="#6-3-实现方案" class="headerlink" title="6.3 实现方案"></a>6.3 实现方案</h4><ul>
<li><p>三种实现思路</p>
<ul>
<li>方案一：<ul>
<li>设置一个分区，即一个reduce任务；在一个reduce中对结果进行排序；</li>
<li>失去了MR框架并行计算的优势</li>
</ul>
</li>
<li>方案二：<ul>
<li>自定义分区，人为指定各温度区间的记录，落入哪个分区；如分区温度边界值分别是-15、0、20，共4个分区</li>
<li>但由于对整个数据集的气温分布不了解，可能某些分区的数据量大，其它的分区小，数据倾斜</li>
</ul>
</li>
<li>方案三：<ul>
<li>通过对键空间采样</li>
<li>只查看一小部分键，获得键的近似分布（好温度的近似分布）</li>
<li>进而据此结果创建分区，实现尽可能的均匀的划分数据集；</li>
<li>Hadoop内置了采样器；InputSampler</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="6-4-MR代码"><a href="#6-4-MR代码" class="headerlink" title="6.4 MR代码"></a>6.4 MR代码</h4><blockquote>
<p>分两大步</p>
</blockquote>
<ul>
<li><p>一、先将数据按气温对天气数据集排序。结果存储为sequencefile文件，气温作为输出键，数据行作为输出值</p>
</li>
<li><p>代码</p>
<blockquote>
<p>此代码处理原始日志文件</p>
<p>结果用SequenceFile格式存储；</p>
<p>温度作为SequenceFile的key；记录作为value</p>
</blockquote>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kaikeba.hadoop.totalorder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.conf.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.fs.Path;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.IntWritable;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.LongWritable;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.Text;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Job;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Mapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.input.FileInputFormat;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.output.FileOutputFormat;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.output.SequenceFileOutputFormat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 此代码处理原始日志文件 1901</span></span><br><span class="line"><span class="comment"> * 结果用SequenceFile格式存储；</span></span><br><span class="line"><span class="comment"> * 温度作为SequenceFile的key；记录作为value</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SortDataPreprocessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//输出的key\value分别是气温、记录</span></span><br><span class="line">  <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">CleanerMapper</span> <span class="keyword">extends</span> <span class="title">Mapper</span>&lt;<span class="title">LongWritable</span>, <span class="title">Text</span>, <span class="title">IntWritable</span>, <span class="title">Text</span>&gt; </span>&#123;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> NcdcRecordParser parser = <span class="keyword">new</span> NcdcRecordParser();</span><br><span class="line">    <span class="keyword">private</span> IntWritable temperature = <span class="keyword">new</span> IntWritable();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(LongWritable key, Text value, Context context)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">      <span class="comment">//0029029070999991901010106004+64333+023450FM-12+000599999V0202701N015919999999N0000001N9-00781+99999102001ADDGF108991999999999999999999</span></span><br><span class="line">      parser.parse(value);</span><br><span class="line">      <span class="keyword">if</span> (parser.isValidTemperature()) &#123;<span class="comment">//是否是有效的记录</span></span><br><span class="line">        temperature.set(parser.getAirTemperature());</span><br><span class="line">        context.write(temperature, value);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">//两个参数：/ncdc/input /ncdc/sfoutput</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (args.length != <span class="number">2</span>) &#123;</span><br><span class="line">      System.out.println(<span class="string">"&lt;input&gt; &lt;output&gt;"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Configuration conf = <span class="keyword">new</span> Configuration();</span><br><span class="line"></span><br><span class="line">    Job job = Job.getInstance(conf, SortDataPreprocessor.class.getSimpleName());</span><br><span class="line">    job.setJarByClass(SortDataPreprocessor.class);</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    FileInputFormat.addInputPath(job, <span class="keyword">new</span> Path(args[<span class="number">0</span>]));</span><br><span class="line">    FileOutputFormat.setOutputPath(job, <span class="keyword">new</span> Path(args[<span class="number">1</span>]));</span><br><span class="line"></span><br><span class="line">    job.setMapperClass(CleanerMapper.class);</span><br><span class="line">    <span class="comment">//最终输出的键、值类型</span></span><br><span class="line">    job.setOutputKeyClass(IntWritable.class);</span><br><span class="line">    job.setOutputValueClass(Text.class);</span><br><span class="line">    <span class="comment">//reduce个数为0</span></span><br><span class="line">    job.setNumReduceTasks(<span class="number">0</span>);</span><br><span class="line">    <span class="comment">//以sequencefile的格式输出</span></span><br><span class="line">    job.setOutputFormatClass(SequenceFileOutputFormat.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//开启job输出压缩功能</span></span><br><span class="line">    <span class="comment">//方案一</span></span><br><span class="line">    conf.set(<span class="string">"mapreduce.output.fileoutputformat.compress"</span>, <span class="string">"true"</span>);</span><br><span class="line">    conf.set(<span class="string">"mapreduce.output.fileoutputformat.compress.type"</span>,<span class="string">"RECORD"</span>);</span><br><span class="line">    <span class="comment">//指定job输出使用的压缩算法</span></span><br><span class="line">    conf.set(<span class="string">"mapreduce.output.fileoutputformat.compress.codec"</span>, <span class="string">"org.apache.hadoop.io.compress.BZip2Codec"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//方案二</span></span><br><span class="line">    <span class="comment">//设置sequencefile的压缩、压缩算法、sequencefile文件压缩格式block</span></span><br><span class="line">    <span class="comment">//SequenceFileOutputFormat.setCompressOutput(job, true);</span></span><br><span class="line">    <span class="comment">//SequenceFileOutputFormat.setOutputCompressorClass(job, GzipCodec.class);</span></span><br><span class="line">    <span class="comment">//SequenceFileOutputFormat.setOutputCompressorClass(job, SnappyCodec.class);</span></span><br><span class="line">    <span class="comment">//SequenceFileOutputFormat.setOutputCompressionType(job, SequenceFile.CompressionType.BLOCK);</span></span><br><span class="line"></span><br><span class="line">    System.exit(job.waitForCompletion(<span class="keyword">true</span>) ? <span class="number">0</span> : <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>二、全局排序</p>
<blockquote>
<p>使用全排序分区器TotalOrderPartitioner</p>
</blockquote>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kaikeba.hadoop.totalorder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.conf.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.filecache.DistributedCache;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.fs.Path;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.IntWritable;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.Text;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Job;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.input.FileInputFormat;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.input.SequenceFileInputFormat;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.output.FileOutputFormat;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.output.SequenceFileOutputFormat;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.partition.InputSampler;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.partition.TotalOrderPartitioner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.URI;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 使用TotalOrderPartitioner全局排序一个SequenceFile文件的内容；</span></span><br><span class="line"><span class="comment"> * 此文件是SortDataPreprocessor的输出文件；</span></span><br><span class="line"><span class="comment"> * key是IntWritble，气象记录中的温度</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SortByTemperatureUsingTotalOrderPartitioner</span></span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 两个参数：/ncdc/sfoutput /ncdc/totalorder</span></span><br><span class="line"><span class="comment">   * 第一个参数是SortDataPreprocessor的输出文件</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (args.length != <span class="number">2</span>) &#123;</span><br><span class="line">      System.out.println(<span class="string">"&lt;input&gt; &lt;output&gt;"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Configuration conf = <span class="keyword">new</span> Configuration();</span><br><span class="line"></span><br><span class="line">    Job job = Job.getInstance(conf, SortByTemperatureUsingTotalOrderPartitioner.class.getSimpleName());</span><br><span class="line">    job.setJarByClass(SortByTemperatureUsingTotalOrderPartitioner.class);</span><br><span class="line"></span><br><span class="line">    FileInputFormat.addInputPath(job, <span class="keyword">new</span> Path(args[<span class="number">0</span>]));</span><br><span class="line">    FileOutputFormat.setOutputPath(job, <span class="keyword">new</span> Path(args[<span class="number">1</span>]));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//输入文件是SequenceFile</span></span><br><span class="line">    job.setInputFormatClass(SequenceFileInputFormat.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Hadoop提供的方法来实现全局排序，要求Mapper的输入、输出的key必须保持类型一致</span></span><br><span class="line">    job.setOutputKeyClass(IntWritable.class);</span><br><span class="line">    job.setOutputFormatClass(SequenceFileOutputFormat.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//分区器：全局排序分区器</span></span><br><span class="line">    job.setPartitionerClass(TotalOrderPartitioner.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//分了3个区；且分区i-1中的key小于i分区中所有的键</span></span><br><span class="line">    job.setNumReduceTasks(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 随机采样器从所有的分片中采样</span></span><br><span class="line"><span class="comment">     * 每一个参数：采样率；</span></span><br><span class="line"><span class="comment">     * 第二个参数：总的采样数</span></span><br><span class="line"><span class="comment">     * 第三个参数：采样的最大分区数；</span></span><br><span class="line"><span class="comment">     * 只要numSamples和maxSplitSampled（第二、第三参数）任一条件满足，则停止采样</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    InputSampler.Sampler&lt;IntWritable, Text&gt; sampler =</span><br><span class="line">            <span class="keyword">new</span> InputSampler.RandomSampler&lt;IntWritable, Text&gt;(<span class="number">0.1</span>, <span class="number">5000</span>, <span class="number">10</span>);</span><br><span class="line"><span class="comment">//    TotalOrderPartitioner.setPartitionFile();</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 存储定义分区的键；即整个数据集中温度的大致分布情况；</span></span><br><span class="line"><span class="comment">     * 由TotalOrderPartitioner读取，作为全排序的分区依据，让每个分区中的数据量近似</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    InputSampler.writePartitionFile(job, sampler);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//根据上边的SequenceFile文件（包含键的近似分布情况），创建分区</span></span><br><span class="line">    String partitionFile = TotalOrderPartitioner.getPartitionFile(job.getConfiguration());</span><br><span class="line">    URI partitionUri = <span class="keyword">new</span> URI(partitionFile);</span><br><span class="line"></span><br><span class="line"><span class="comment">//    JobConf jobConf = new JobConf();</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//与所有map任务共享此文件，添加到分布式缓存中</span></span><br><span class="line">    DistributedCache.addCacheFile(partitionUri, job.getConfiguration());</span><br><span class="line"><span class="comment">//    job.addCacheFile(partitionUri);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//方案一：输出的文件RECORD级别，使用BZip2Codec进行压缩</span></span><br><span class="line">    conf.set(<span class="string">"mapreduce.output.fileoutputformat.compress"</span>, <span class="string">"true"</span>);</span><br><span class="line">    conf.set(<span class="string">"mapreduce.output.fileoutputformat.compress.type"</span>,<span class="string">"RECORD"</span>);</span><br><span class="line">    <span class="comment">//指定job输出使用的压缩算法</span></span><br><span class="line">    conf.set(<span class="string">"mapreduce.output.fileoutputformat.compress.codec"</span>, <span class="string">"org.apache.hadoop.io.compress.BZip2Codec"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//方案二</span></span><br><span class="line">    <span class="comment">//SequenceFileOutputFormat.setCompressOutput(job, true);</span></span><br><span class="line">    <span class="comment">//SequenceFileOutputFormat.setOutputCompressorClass(job, GzipCodec.class);</span></span><br><span class="line">    <span class="comment">//SequenceFileOutputFormat.setOutputCompressionType(job, CompressionType.BLOCK);</span></span><br><span class="line"></span><br><span class="line">    System.exit(job.waitForCompletion(<span class="keyword">true</span>) ? <span class="number">0</span> : <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="6-5-总结"><a href="#6-5-总结" class="headerlink" title="6.5 总结"></a>6.5 总结</h4><ul>
<li><p>对大量数据进行全局排序</p>
<ul>
<li><p>先使用InputSampler.Sampler采样器，对整个key空间进行采样，得到key的近似分布</p>
</li>
<li><p>保存到key分布情况文件中</p>
</li>
<li><p>使用TotalOrderPartitioner，利用上边的key分布情况文件，进行分区；每个分区的数据量近似，从而防止数据倾斜</p>
</li>
</ul>
</li>
</ul>
<h2 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h2><ol>
<li>描述MR的shuffle全流程（面试）</li>
<li>搭建MAVEN工程，统计词频，并提交集群运行，查看结果</li>
<li>利用搜狗数据，找出所有独立的uid并写入HDFS</li>
<li>利用搜狗数据，找出所有独立的uid出现次数，并写入HDFS，并要求使用Map端的Combine操作</li>
<li>谈谈什么是数据倾斜，什么情况会造成数据倾斜？（面试）</li>
<li>对MR数据倾斜，如何解决？（面试）</li>
</ol>

        
        <br />
        <div id="comment-container">
        </div>
        <div id="disqus_thread"></div>

        <div id="lv-container">
        </div>

    </div>
</div>

    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        

        

    </ul>
    
    <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>
        Created By <a href="https://hexo.io/">Hexo</a>  Theme <a href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a></p>
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "search.json"
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="/js/index.js"></script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




</html>
